import{t as y,u as S,w as N,v as b,T as s,D as T,n as D,B}from"./firebase-Bi_eiI5S.js";import{d as p}from"./index-CGsLMNMp.js";import{a as O,s as d,Z as F}from"./vendor-CUhUAKZ9.js";const x={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_FIREBASE_API_KEY:"AIzaSyDPunF6Pj8gEm7QNl-5-gXDzsLiaoNO5kM",VITE_FIREBASE_APP_ID:"1:599375908983:web:b28b69a3770c0947063672",VITE_FIREBASE_AUTH_DOMAIN:"atemimx.firebaseapp.com",VITE_FIREBASE_CONFIG:'{"apiKey":"AIzaSyDPunF6Pj8gEm7QNl-5-gXDzsLiaoNO5kM","authDomain":"atemimx.firebaseapp.com","projectId":"atemimx","storageBucket":"atemimx.firebasestorage.app","messagingSenderId":"599375908983","appId":"1:599375908983:web:b28b69a3770c0947063672"}',VITE_FIREBASE_FUNCTIONS_REGION:"us-central1",VITE_FIREBASE_MESSAGING_SENDER_ID:"599375908983",VITE_FIREBASE_PROJECT_ID:"atemimx",VITE_FIREBASE_STORAGE_BUCKET:"atemimx.firebasestorage.app",VITE_GEMINI_API_KEY:""},P=1,w="VITE_ENCRYPTION_MASTER_KEY",C=new TextEncoder,M=new TextDecoder,A=()=>{const e=typeof window<"u"?window.crypto:typeof globalThis<"u"?globalThis==null?void 0:globalThis.crypto:void 0;if(!e)throw new Error("La API de cifrado del navegador no está disponible.");return e},l=()=>{const e=A();if(!e.subtle)throw new Error("El motor de cifrado no está disponible en este entorno.");return e.subtle},_=()=>{if(typeof globalThis>"u")return null;const e=globalThis.Buffer;return e&&typeof e.from=="function"?e:null},m=e=>{const t=e.replace(/[^A-Za-z0-9+/=]/g,"");if(typeof window<"u"&&typeof window.atob=="function"){const a=window.atob(t),n=new Uint8Array(a.length);for(let i=0;i<a.length;i+=1)n[i]=a.charCodeAt(i);return n}const r=_();if(!r)throw new Error("El entorno actual no soporta decodificación Base64.");const o=r.from(t,"base64");return new Uint8Array(o.buffer,o.byteOffset,o.byteLength)},g=e=>{const t=e instanceof Uint8Array?e:new Uint8Array(e);if(typeof window<"u"&&typeof window.btoa=="function"){let o="";return t.forEach(a=>{o+=String.fromCharCode(a)}),window.btoa(o)}const r=_();if(!r)throw new Error("El entorno actual no soporta codificación Base64.");return r.from(t).toString("base64")},v=(()=>{let e=null;return t=>{if(t)return l().importKey("raw",t,"AES-GCM",!1,["encrypt","decrypt"]);if(!e){const r=x[w];if(!r)throw new Error(`Falta la variable de entorno ${w} para habilitar el cifrado.`);const o=m(r.trim());e=l().importKey("raw",o,"AES-GCM",!1,["encrypt","decrypt"])}return e}})(),h=e=>v(),V=()=>{const e=new Uint8Array(12);return A().getRandomValues(e),e},L=async(e,t)=>{const r=await h(),o=V(),a=C.encode(e),n=await l().encrypt({name:"AES-GCM",iv:o},r,a);return{version:P,iv:g(o),ciphertext:g(n)}},K=async(e,t)=>{if(!(e!=null&&e.iv)||!(e!=null&&e.ciphertext))throw new Error("El payload cifrado es inválido.");const r=await h(),o=m(e.iv),a=m(e.ciphertext),n=await l().decrypt({name:"AES-GCM",iv:o},r,a);return M.decode(n)},G=async(e,t)=>L(JSON.stringify(e)),U=async(e,t)=>{const r=await K(e);return JSON.parse(r)},Y=e=>!Number.isNaN(Date.parse(e)),I=O({title:d({required_error:"El titulo es obligatorio."}).trim().min(3,{message:"El titulo debe tener al menos 3 caracteres."}).max(120,{message:"El titulo debe tener maximo 120 caracteres."}),description:d({required_error:"La descripcion es obligatoria."}).trim().min(10,{message:"La descripcion debe tener al menos 10 caracteres."}).max(2e3,{message:"La descripcion debe tener maximo 2000 caracteres."}),date:d({required_error:"La fecha es obligatoria."}).trim().refine(Y,{message:"La fecha debe tener un formato valido (YYYY-MM-DD)."}),category:d({required_error:"La categoria es obligatoria."}).trim().min(3,{message:"La categoria debe tener al menos 3 caracteres."}).max(50,{message:"La categoria debe tener maximo 50 caracteres."}),uid:d({required_error:"El identificador de usuario es obligatorio."}).trim().min(1,{message:"El identificador de usuario es obligatorio."})}),f="reports";I.omit({uid:!0}).partial();const z=e=>{const t=e.errors[0];return`Datos de reporte invalidos: ${(t==null?void 0:t.message)??"verifica la informacion ingresada."}`},k=e=>{try{return I.parse(e)}catch(t){throw t instanceof F?new Error(z(t)):t}},q=e=>s.fromDate(new Date(e)),u=e=>{const t=e==null?void 0:e.trim();return t&&t.length>0?t:null},j=(e,t)=>{var r;return{title:e.title,description:e.description,category:e.category,dateISO:e.date,ownerName:u(t==null?void 0:t.name)??null,ownerEmail:u((r=t==null?void 0:t.email)==null?void 0:r.toLowerCase())??null,ownerRole:u(t==null?void 0:t.role)??null}},J=async e=>e.payload&&typeof e.payload=="object"?U(e.payload):{title:typeof e.title=="string"?e.title:"",description:typeof e.description=="string"?e.description:"",category:typeof e.category=="string"?e.category:"",dateISO:typeof e.date=="string"?e.date:e.date instanceof s?e.date.toDate().toISOString():"",ownerName:typeof e.ownerName=="string"?e.ownerName:null,ownerEmail:typeof e.ownerEmail=="string"?e.ownerEmail:null,ownerRole:typeof e.ownerRole=="string"?e.ownerRole:null},X=async(e,t)=>{const r=k(e),o=s.now(),a=j(r,t),n=await G(a),i=y(p,f),c={uid:r.uid,date:q(r.date),createdAt:o,updatedAt:o,payload:n,encryptionVersion:n.version};try{return{id:(await T(i,c)).id,uid:c.uid,title:a.title,description:a.description,category:a.category,date:c.date,createdAt:c.createdAt,updatedAt:c.updatedAt,ownerName:a.ownerName,ownerEmail:a.ownerEmail,ownerRole:a.ownerRole}}catch(E){throw console.error("[Firestore] Failed to create report:",E),new Error("No se pudo crear el reporte en Firestore.")}},R=async e=>{const t=e.data(),r=await J(t);return{id:e.id,uid:typeof t.uid=="string"?t.uid:"",title:r.title,description:r.description,category:r.category,date:t.date??s.now(),createdAt:t.createdAt??s.now(),updatedAt:t.updatedAt??s.now(),ownerName:r.ownerName,ownerEmail:r.ownerEmail,ownerRole:r.ownerRole}},H=async e=>{try{const t=y(p,f),r=S(t,N("uid","==",e)),o=await b(r);return(await Promise.all(o.docs.map(R))).sort((n,i)=>i.updatedAt.toMillis()-n.updatedAt.toMillis())}catch(t){throw console.error("[Firestore] Failed to fetch reports for user:",t),new Error("No se pudieron obtener los reportes del usuario.")}},W=async()=>{try{const e=y(p,f),t=await b(e);return(await Promise.all(t.docs.map(R))).sort((o,a)=>a.updatedAt.toMillis()-o.updatedAt.toMillis())}catch(e){throw console.error("[Firestore] Failed to fetch all reports:",e),new Error("No se pudieron obtener los reportes registrados.")}},ee=async e=>{try{const t=D(p,f,e);await B(t)}catch(t){throw console.error(`[Firestore] Failed to delete report (${e}):`,t),new Error("No se pudo eliminar el reporte.")}};export{W as a,X as c,ee as d,H as g};
