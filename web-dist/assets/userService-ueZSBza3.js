import{n as l,p as C,T as c,q as j,t as v,u as N,w as P,v as T,x as D,F as w,y as M,z as L}from"./firebase-Bi_eiI5S.js";import{d as s,a as g,c as $}from"./index-CZdUSK2y.js";import{a as _,s as n,i as z,b as U}from"./vendor-CUhUAKZ9.js";const m="users",x="docentes",b="plantilla_docente",q={admin:"admin",direccion:"admin",director:"admin",clerk:"clerk",secretaria:"clerk",secretary:"clerk",teacher:"teacher",docente:"teacher",profesor:"teacher",profesora:"teacher",prefect:"prefect",prefecto:"prefect",prefectura:"prefect",medical:"medical",medico:"medical",doctora:"medical",socialwork:"socialWork",trabajo_social:"socialWork",social:"socialWork",guidance:"guidance",orientacion:"guidance",orientadora:"guidance"},I=e=>{const r=e.trim().toLowerCase();return q[r]??"teacher"},oe={clerk:"Secretaria",teacher:"Docente",prefect:"Prefectura",medical:"Servicio Medico",socialWork:"Trabajo Social",guidance:"Orientacion",admin:"Direccion"},B=_({email:n().email(),nombreCompleto:n().min(3).max(140).optional(),nombreNormalizado:n().min(3).max(140).optional(),rol:n().min(3).max(40),autorizado:U(),fechaRegistro:z(c).optional(),autorizadoPor:n().nullable().optional(),plantillaDocenteId:n().optional()}),Q=_({nombre:n().min(3).max(120),plantel:n().min(2).max(80),extension:n().min(1).max(10).optional(),createdAt:z(c).optional(),updatedAt:z(c).optional()}),H=_({nombre_completo:n().min(3).max(140),registrado:U(),uid_asociado:n().nullable(),rol:n().min(3).max(40),rol_canonico:n().min(3).max(40).optional()}),O=e=>e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z\s]/g," ").trim().replace(/\s+/g," ").toUpperCase(),Z=e=>e.replace(/\s+/g,"_"),k=e=>{const r=e.trim().replace(/\s+/g," ");return r?r.toLowerCase().split(" ").map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" "):""},y=e=>{if(!e.exists())return null;const r=B.safeParse(e.data());if(!r.success)return console.error("[SASE-310] Perfil de usuario invalido:",r.error),null;const o=r.data,a=I(o.rol),t=o.nombreCompleto??k(e.get("nombre")??""),i=o.nombreNormalizado??O(t||o.email);return{id:e.id,...o,rol:a,nombreCompleto:t||o.email,nombreNormalizado:i,fechaRegistro:o.fechaRegistro??c.now(),autorizadoPor:o.autorizadoPor??null}},G=e=>{if(!e.exists())return null;const r=Q.safeParse(e.data());if(!r.success)return console.error("[SASE-310] Datos docentes invalidos:",r.error),null;const o=r.data;return{id:e.id,...o,createdAt:o.createdAt??c.now(),updatedAt:o.updatedAt??c.now()}},A=e=>{if(!e.exists())return null;const r=H.safeParse(e.data());if(!r.success)return console.error("[SASE-310] Entrada de plantilla invalida:",r.error),null;const o=r.data,a=I(o.rol_canonico??o.rol),{rol_canonico:t=void 0,...i}=o;return{id:e.id,...i,rol:a}},E=(e,r)=>{throw r instanceof w?console.error(`[SASE-310] ${e} (code: ${r.code})`):console.error(`[SASE-310] ${e}:`,r),new Error("No se pudo completar la operacion solicitada. Intenta mas tarde.")},J=async e=>{const r=Z(e),o=l(s,b,r);try{const a=await L(o),t=A(a);if(t)return t}catch(a){if(a instanceof w&&a.code!=="permission-denied"||!(a instanceof w))throw a}try{const a=v(s,b),t=N(a,P("nombre_completo","==",e)),d=(await T(t)).docs[0];return d?A(d):null}catch(a){throw a instanceof w&&a.code==="permission-denied"?new Error("No fue posible validar la plantilla de docentes. Contacta al administrador."):a}},K=async e=>{var r;try{await e.delete()}catch(o){console.error(`[SASE-310] No se pudo revertir el usuario ${e.uid}:`,o)}finally{((r=g.currentUser)==null?void 0:r.uid)===e.uid&&await g.signOut().catch(()=>{})}},re=async e=>{const r=k(e.nombreCompleto),o=O(e.nombreCompleto),a=e.email.trim().toLowerCase();if(!r||!o)throw new Error("Ingresa tu nombre completo tal como aparece en la plantilla autorizada.");let t=null;try{t=await $(a,e.password),await M(t,{displayName:r}).catch(()=>{});const i=await J(o);if(!i)throw new Error("No fue posible validar la plantilla autorizada. Contacta al administrador.");if(i.registrado&&(!i.uid_asociado||i.uid_asociado!==t.uid))throw new Error("Este docente ya cuenta con un registro activo.");const d=c.now(),u=i.rol,f={email:a,nombreCompleto:r,nombreNormalizado:o,rol:u,autorizado:!0,fechaRegistro:d,autorizadoPor:null,plantillaDocenteId:i.id},p=l(s,b,i.id),S=l(s,m,t.uid);await D(s,async R=>{const F=await R.get(p),h=A(F);if(!h)throw new Error("La plantilla de docentes no se encuentra disponible.");if(h.registrado&&(!h.uid_asociado||h.uid_asociado!==t.uid))throw new Error("Este docente ya se autorizo previamente.");R.set(S,f,{merge:!0}),R.update(p,{registrado:!0,uid_asociado:t.uid,correo_registrado:a,actualizado_en:d,rol_canonico:u})});const W={id:t.uid,...f};return{user:t,profile:W}}catch(i){throw t&&await K(t),i instanceof Error?i:new Error("No fue posible completar el registro con la whitelist.")}},ae=async(e,r)=>{const o=await V(e);if(o)return o;throw new Error("Tu cuenta no esta autorizada en SASE-310. Contacta al administrador.")},V=async e=>{const r=l(s,m,e);try{const o=await L(r);return y(o)}catch(o){return E("Recuperacion de perfil fallida",o)}},te=(e,r,o)=>{const a=l(s,m,e);return C(a,t=>{r(y(t))},t=>{console.error("[SASE-310] Observador de perfil fallido:",t),o==null||o(t)})},ie=async()=>{try{const e=v(s,m),r=N(e,P("autorizado","==",!1));return(await T(r)).docs.map(a=>y(a)).filter(a=>a!==null).sort((a,t)=>t.fechaRegistro.toMillis()-a.fechaRegistro.toMillis())}catch(e){return E("Listado de usuarios pendientes fallido",e)}},ne=async(e,r)=>{var i,d;const o=l(s,m,e),a=((i=g.currentUser)==null?void 0:i.email)??((d=g.currentUser)==null?void 0:d.uid)??null,t=c.now();try{await D(s,async u=>{const f=await u.get(o),p=y(f);if(!p)throw new Error("No se encontrÃ³ el perfil del usuario a aprobar.");if(u.update(o,{autorizado:!0,rol:r,autorizadoPor:a,fechaAutorizacion:t}),p.plantillaDocenteId){const S=l(s,b,p.plantillaDocenteId);u.update(S,{registrado:!0,uid_asociado:e,autorizado_en:t,autorizado_por:a})}})}catch(u){E("Aprobacion de usuario fallida",u)}},se=(e,r,o)=>{const a=l(s,x,e);return C(a,t=>{r(G(t))},t=>{console.error("[SASE-310] Observador de datos docentes fallido:",t),o==null||o(t)})},ce=async(e,r)=>{const o=l(s,x,e);try{const a={...r,createdAt:r.createdAt??c.now(),updatedAt:c.now()};await j(o,a,{merge:!0})}catch(a){E("Registro de datos docentes fallido",a)}};export{oe as R,ne as a,se as b,ae as e,ie as g,te as o,re as r,ce as s};
