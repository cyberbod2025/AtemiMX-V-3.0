import{r as n,j as e,S as U,l as _,f as q,M as T,q as S,R as g,U as D,s as K,t as z,u as J,v as V,P as W,w as Q,x as A,y as X,z as Y,d as Z,B as ee,G as se,H as ae,J as te}from"./index-J06LgYwp.js";const ne=({onRecordingComplete:s})=>{const[x,i]=n.useState(!1),t=n.useRef(null),l=n.useRef([]),c=n.useRef(null),r=()=>{t.current&&t.current.state==="recording"&&t.current.stop(),c.current&&(c.current.getTracks().forEach(o=>o.stop()),c.current=null),i(!1)},N=async()=>{try{const o=await navigator.mediaDevices.getUserMedia({audio:!0});c.current=o;const u=new MediaRecorder(o);t.current=u,l.current=[],u.ondataavailable=h=>{l.current.push(h.data)},u.onstop=()=>{var j;const h=((j=t.current)==null?void 0:j.mimeType)||"audio/webm",b=new Blob(l.current,{type:h});s(b),l.current=[]},u.start(),i(!0)}catch(o){console.error("Could not start recording:",o),alert("No se pudo acceder al micrófono. Por favor, verifica los permisos.")}},p=()=>{x?r():N()};return e.jsx("button",{type:"button",onClick:p,className:`flex items-center text-sm px-3 py-1 rounded transition-colors ${x?"bg-red-500 text-white hover:bg-red-600":"bg-gray-200 hover:bg-gray-300"}`,children:x?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"h-4 w-4 mr-1"}),"Detener"]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-4 w-4 mr-1"}),"Grabar Audio"]})})},re=({report:s,student:x,teacher:i})=>{var c;const t=q.find(r=>r.id===s.studentId),l=((c=T.find(r=>r.id===s.resolvedById))==null?void 0:c.name)||"N/A";return e.jsxs("div",{className:"p-8 font-sans bg-white text-gray-900",children:[e.jsxs("header",{className:"text-center mb-8 border-b-2 pb-4 border-gray-900",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Reporte de Incidencia Escolar"}),e.jsx("p",{className:"text-lg",children:'Secundaria Técnica No. 310 "Atemi"'})]}),e.jsxs("section",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Detalles del Reporte"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-8 gap-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Fecha del Reporte:"})," ",new Date(s.date).toLocaleString()]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Estado:"})," ",s.status]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Alumno:"})," ",x]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Grado y Grupo:"})," ",t==null?void 0:t.grade,'° "',t==null?void 0:t.group,'"']}),e.jsxs("div",{children:[e.jsx("strong",{children:"Reportado por:"})," ",i]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Tipo de Incidencia:"})," ",s.type]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("strong",{children:"Asignatura/Motivo:"})," ",s.subject]})]})]}),e.jsxs("section",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Descripción de Hechos"}),e.jsx("p",{className:"text-sm leading-relaxed",children:s.description})]}),e.jsxs("section",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Acciones Inmediatas"}),e.jsx("p",{className:"text-sm leading-relaxed",children:s.actionsTaken})]}),s.comments.length>0&&e.jsxs("section",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Historial de Seguimiento"}),e.jsx("div",{className:"space-y-3",children:s.comments.map(r=>e.jsxs("div",{className:"text-sm border-l-2 pl-3",children:[e.jsxs("p",{children:[e.jsx("strong",{children:r.userName})," (",new Date(r.date).toLocaleString(),")"]}),e.jsx("p",{className:"mt-1",children:r.text})]},r.id))})]}),s.status==="Resuelto"&&e.jsxs("section",{className:"mb-6 bg-gray-100 p-4 rounded",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Resolución del Caso"}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Fecha de Resolución:"})," ",new Date(s.resolvedDate).toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Resuelto por:"})," ",l]}),e.jsx("p",{className:"mt-2",children:e.jsx("strong",{children:"Acuerdos y Notas Finales:"})}),e.jsx("p",{className:"mt-1 leading-relaxed",children:s.resolutionNotes})]})]}),e.jsxs("footer",{className:"mt-24 pt-8",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-12 text-center",children:"Firmas de Enterado y Acuerdos"}),e.jsxs("div",{className:"grid grid-cols-3 gap-12 text-center text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"border-t border-gray-700 pt-2",children:"Firma del Alumno(a)"}),e.jsx("div",{className:"mt-1",children:x})]}),e.jsx("div",{children:e.jsx("div",{className:"border-t border-gray-700 pt-2",children:"Firma del Padre, Madre o Tutor"})}),e.jsxs("div",{children:[e.jsx("div",{className:"border-t border-gray-700 pt-2",children:"Firma del Personal Escolar"}),e.jsx("div",{className:"mt-1",children:l!=="N/A"?l:i})]})]})]})]})},ce=({report:s,viewStudentProfile:x,onReportUpdate:i,currentUser:t,isStudentProfileView:l})=>{var k;const[c,r]=n.useState(!1),[N,p]=n.useState("Cargando..."),[o,u]=n.useState("Cargando..."),[h,b]=n.useState(""),[j,f]=n.useState(!1),[v,w]=n.useState(""),R=n.useRef(null);n.useEffect(()=>{const a=localStorage.getItem(`draft-comment-${s.id}`);a&&b(a)},[s.id]);const E=a=>{b(a.target.value),localStorage.setItem(`draft-comment-${s.id}`,a.target.value)};n.useEffect(()=>{(async()=>{const d=await Z(s.studentId),m=await ee(s.teacherId);u((d==null?void 0:d.name)||"Desconocido"),p((m==null?void 0:m.name)||"Desconocido")})()},[s.studentId,s.teacherId]);const P=()=>r(!c),B=async()=>{if(h.trim()==="")return;const a={userId:t.id,userName:t.name,text:h,date:new Date().toISOString()},d=await se(s.id,a);d&&(i(d),b(""),localStorage.removeItem(`draft-comment-${s.id}`))},C=async(a,d)=>{const m=new FileReader;m.readAsDataURL(a),m.onload=async()=>{const O={type:d,url:m.result,fileName:d==="photo"?a.name:`grabacion-${new Date().toISOString()}.webm`,date:new Date().toISOString()},I=await te(s.id,O);I&&i(I)}},F=a=>{a.target.files&&a.target.files[0]&&C(a.target.files[0],"photo")},M=a=>{C(a,"audio")},$=async()=>{if(v.trim()==="")return;const a=await ae(s.id,t.id,v);a&&(i(a),f(!1),w(""))},L=()=>{var d;const a=window.open("","_blank");if(a){const m=(d=document.getElementById(`printable-${s.id}`))==null?void 0:d.innerHTML;a.document.write(`<html><head><title>Reporte de Incidencia</title><script src="https://cdn.tailwindcss.com"><\/script></head><body>${m}</body></html>`),a.document.close(),setTimeout(()=>{a.print()},500)}},H=((k=T.find(a=>a.id===s.resolvedById))==null?void 0:k.name)||"Desconocido",y=[S.Guidance,S.Admin].includes(t.role),G={[g.New]:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300",[g.InProgress]:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300",[g.Resolved]:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300"};return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden",children:[e.jsx("div",{className:"p-4 cursor-pointer",onClick:P,children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-lg text-gray-800 dark:text-white",children:s.subject}),e.jsxs("div",{className:"flex items-center text-sm text-gray-500 dark:text-gray-400 mt-1",children:[!l&&e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"h-4 w-4 mr-1"}),e.jsx("button",{onClick:a=>{a.stopPropagation(),x(s.studentId)},className:"hover:underline font-semibold",children:o}),e.jsx("span",{className:"mx-2",children:"|"})]}),e.jsx(K,{className:"h-4 w-4 mr-1"}),e.jsx("span",{children:new Date(s.date).toLocaleDateString()})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full ${G[s.status]}`,children:s.status}),e.jsx("button",{className:"text-gray-500 hover:text-gray-700",children:c?e.jsx(z,{className:"h-5 w-5"}):e.jsx(J,{className:"h-5 w-5"})})]})]})}),c&&e.jsxs("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 animate-fade-in-down space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"text-gray-600 dark:text-gray-300",children:"Reportado por:"})," ",N]}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-semibold flex items-center",children:[e.jsx(V,{className:"h-5 w-5 mr-2"}),"Descripción"]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:s.description})]}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-semibold flex items-center",children:[e.jsx(W,{className:"h-5 w-5 mr-2"}),"Acciones Tomadas"]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:s.actionsTaken})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsxs("h5",{className:"font-semibold flex items-center mb-2",children:[e.jsx(Q,{className:"h-5 w-5 mr-2"}),"Evidencia Adjunta"]}),e.jsx("div",{className:"space-y-2",children:s.evidence.map(a=>e.jsxs("div",{className:"flex items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md",children:[a.type==="photo"?e.jsx(A,{className:"h-5 w-5 mr-2"}):e.jsx(D,{className:"h-5 w-5 mr-2"}),e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 hover:underline text-sm",children:a.fileName})]},a.id))}),y&&s.status!==g.Resolved&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"file",accept:"image/*",ref:R,onChange:F,className:"hidden"}),e.jsxs("button",{onClick:()=>{var a;return(a=R.current)==null?void 0:a.click()},className:"flex items-center text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300",children:[e.jsx(A,{className:"h-4 w-4 mr-1"}),"Adjuntar Foto"]}),e.jsx(ne,{onRecordingComplete:M})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h5",{className:"font-semibold mb-2",children:"Historial de Comunicación"}),e.jsx("div",{className:"space-y-3 max-h-48 overflow-y-auto",children:s.comments.map(a=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"font-semibold",children:[a.userName," ",e.jsxs("span",{className:"text-xs text-gray-500",children:["(",new Date(a.date).toLocaleString(),")"]})]}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 whitespace-pre-wrap",children:a.text})]},a.id))}),y&&s.status!==g.Resolved&&e.jsxs("div",{className:"mt-4",children:[e.jsx("textarea",{value:h,onChange:E,rows:3,placeholder:"Añadir comentario o nota de seguimiento...",className:"w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"}),e.jsx("button",{onClick:B,className:"mt-2 bg-blue-600 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-blue-700",children:"Publicar"})]})]}),s.status===g.Resolved&&e.jsxs("div",{className:"pt-4 border-t bg-green-50 dark:bg-green-900/20 p-3 rounded-md",children:[e.jsxs("h5",{className:"font-semibold flex items-center text-green-800 dark:text-green-300",children:[e.jsx(X,{className:"h-5 w-5 mr-2"}),"Caso Resuelto"]}),e.jsxs("p",{className:"text-sm mt-1",children:[e.jsx("strong",{className:"block",children:"Resuelto por:"})," ",H," el ",new Date(s.resolvedDate).toLocaleDateString()]}),e.jsxs("p",{className:"text-sm mt-2",children:[e.jsx("strong",{className:"block",children:"Notas de Resolución:"})," ",s.resolutionNotes]})]}),e.jsxs("div",{className:"pt-4 border-t flex justify-between items-start",children:[y&&s.status!==g.Resolved&&e.jsxs("div",{children:[!j&&e.jsx("button",{onClick:()=>f(!0),className:"bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-green-700",children:"Resolver Caso"}),j&&e.jsxs("div",{className:"animate-fade-in-down",children:[e.jsx("textarea",{value:v,onChange:a=>w(a.target.value),rows:3,placeholder:"Añadir notas finales de la resolución del caso...",className:"w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"}),e.jsxs("div",{className:"mt-2 space-x-2",children:[e.jsx("button",{onClick:$,className:"bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-green-700",children:"Confirmar Resolución"}),e.jsx("button",{onClick:()=>f(!1),className:"bg-gray-300 px-3 py-1 rounded text-sm",children:"Cancelar"})]})]})]}),e.jsxs("button",{onClick:L,className:"flex items-center text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded hover:bg-gray-300",children:[e.jsx(Y,{className:"h-4 w-4 mr-1"}),"Imprimir"]})]}),e.jsx("div",{id:`printable-${s.id}`,className:"hidden",children:e.jsx(re,{report:s,student:o,teacher:N})})]})]})};export{ce as R};
