import{d as B,g as z,a as G,s as J,M as U,r as f,j as e,D as q,C as H,b as Q,c as W}from"./index-Cq_eeqDJ.js";import{R as X}from"./ReportForm-DxsEYYcF.js";import{R as Y}from"./ReportCard-zheg6J46.js";import{R as F,C as P,T as A}from"./CategoricalChart-BlHM64Ew.js";import{P as O,a as V}from"./PieChart-QDhOOHTF.js";import"./geminiService-fkZN5fdV.js";const K="gradebooks",Z=async i=>{const s=B(G,K,i),t=await z(s);return t.exists()?t.data():null},ee=async(i,s)=>{const t=B(G,K,i);await J(t,s,{merge:!0})},D=[{min:0,max:5.9,bg:"#fee2e2",fg:"#991b1b"},{min:6,max:7.9,bg:"#fef9c3",fg:"#92400e"},{min:8,max:10,bg:"#dcfce7",fg:"#14532d"}],te=()=>{const i=U.map(a=>({studentId:a.id,displayName:a.name})),s=[{id:"unidad1",label:"Unidad 1 · Diagnóstico",columns:[{id:"diag",label:"Diagnóstico (10)",type:"numeric",weight:.2,config:{min:0,max:10,colorRules:D}},{id:"participacion",label:"Participación",type:"icon",weight:.1,config:{icons:[{value:"⭐️",label:"Sobresaliente",points:10},{value:"✅",label:"Cumple",points:8},{value:"⚠️",label:"Atender",points:6}]}},{id:"producto1",label:"Producto integrador",type:"numeric",weight:.4,config:{min:0,max:100,colorRules:D}},{id:"resumen",label:"Resumen autoevaluación",type:"text"},{id:"promedio_u1",label:"Promedio U1",type:"formula",config:{formula:"average",fromColumns:["diag","producto1"]}}]},{id:"unidad2",label:"Unidad 2 · Proyecto",columns:[{id:"investigacion",label:"Investigación",type:"numeric",weight:.35,config:{min:0,max:10,colorRules:D}},{id:"rubrica",label:"Rúbrica Equipo",type:"numeric",weight:.35,config:{min:0,max:4,colorRules:[{min:0,max:1.9,bg:"#fee2e2",fg:"#991b1b"},{min:2,max:2.9,bg:"#fef9c3",fg:"#92400e"},{min:3,max:4,bg:"#dcfce7",fg:"#14532d"}]}},{id:"badgeMaker",label:"Insignias",type:"formula",config:{formula:"badgeMaker",fromColumns:["participacion"]}}]}],t=(a,p,N)=>({studentId:a,columnId:p,value:N}),n={};return i.forEach((a,p)=>{n[a.studentId]={},n[a.studentId].diag=t(a.studentId,"diag",6+p%5),n[a.studentId].participacion=t(a.studentId,"participacion",p%2===0?"⭐️":"✅"),n[a.studentId].producto1=t(a.studentId,"producto1",70+p*3),n[a.studentId].resumen=t(a.studentId,"resumen","Entrega puntual y participa."),n[a.studentId].investigacion=t(a.studentId,"investigacion",7+p%3),n[a.studentId].rubrica=t(a.studentId,"rubrica",2+p%3)}),{tabs:s,rows:i,cells:n}},ae=(i={})=>{var C;const{teacherId:s}=i,t=f.useMemo(()=>te(),[]),[n,a]=f.useState(t),[p,N]=f.useState(((C=n.tabs[0])==null?void 0:C.id)??"unidad1"),[_,y]=f.useState(!!s),[g,u]=f.useState(!1),[j,x]=f.useState(null),c=f.useRef(null),b=f.useRef(null);f.useEffect(()=>{if(!s){y(!1),a(t);return}y(!0),Z(s).then(o=>{var m;o?(a(o),N(((m=o.tabs[0])==null?void 0:m.id)??"unidad1")):a(t),x(null)}).catch(o=>{console.error("[Gradebook] No se pudo cargar el cuaderno",o),x("No pudimos sincronizar el cuaderno. Mostramos una versión local."),a(t)}).finally(()=>y(!1))},[t,s]),f.useEffect(()=>()=>{c.current&&clearTimeout(c.current)},[]);const I=o=>{s&&(b.current=o,c.current&&clearTimeout(c.current),c.current=setTimeout(async()=>{if(b.current){u(!0);try{await ee(s,b.current),x(null)}catch(m){console.error("[Gradebook] No se pudo guardar el cuaderno",m),x("No pudimos guardar los cambios. Revisa tu conexión.")}finally{u(!1)}}},800))},r=(o,m,d)=>{a(h=>{const R=JSON.parse(JSON.stringify(h));return R.cells[o]||(R.cells[o]={}),R.cells[o][m]={studentId:o,columnId:m,value:d},I(R),R})},l=(o,m)=>{var d,h;return((h=(d=n.cells[o])==null?void 0:d[m])==null?void 0:h.value)??null},v=(o,m)=>{const d=l(o,m);return typeof d=="number"?d:typeof d=="string"&&d.trim().length>0&&!Number.isNaN(Number(d))?Number(d):null},w=(o,m=p)=>{const d=n.tabs.find(k=>k.id===m);if(!d)return 0;const h=d.columns.filter(k=>k.type!=="text"),R=h.reduce((k,S)=>{const E=v(o,S.id);if(E===null)return k;const $=S.weight??1;return k+E*$},0),L=h.reduce((k,S)=>k+(S.weight??1),0)||1;return Number((R/L).toFixed(2))},M=o=>{if(n.rows.length===0)return 0;const m=n.rows.reduce((d,h)=>d+w(h.studentId,o),0);return Number((m/n.rows.length).toFixed(2))};return{tabs:n.tabs,activeTabId:p,setActiveTabId:N,rows:n.rows,getValue:l,getNumericValue:v,updateCell:r,getAverageForStudent:w,getTabAverage:M,model:n,loading:_,saving:g,error:j}},se=(i,s)=>{var n;if(!((n=i.config)!=null&&n.colorRules)||s===null)return{};const t=i.config.colorRules.find(a=>s>=a.min&&s<=a.max);return t?{backgroundColor:t.bg,color:t.fg}:{}},ne=(i,s)=>{var t;return s==null||s===""?"—":i.type==="numeric"&&typeof s=="number"?s.toFixed((t=i.config)!=null&&t.max&&i.config.max<=5?1:0):s},re=({teacherId:i})=>{const{tabs:s,activeTabId:t,setActiveTabId:n,rows:a,getValue:p,getNumericValue:N,updateCell:_,getAverageForStudent:y,loading:g,saving:u,error:j}=ae({teacherId:i}),x=s.find(r=>r.id===t)??s[0];if(!x)return null;const c=(r,l,v)=>{_(r,l,v.target.value)},b=(r,l)=>{var C,o,m;const v=p(r,l.id),w=N(r,l.id),M=l.type==="numeric"?se(l,w):void 0;if(l.type==="numeric")return e.jsx("input",{type:"number",className:"gradebook__cell-input",value:v??"",onChange:d=>c(r,l.id,d),min:((C=l.config)==null?void 0:C.min)??0,max:((o=l.config)==null?void 0:o.max)??100,style:M});if(l.type==="text")return e.jsx("textarea",{className:"gradebook__cell-text",value:v??"",onChange:d=>c(r,l.id,d)});if(l.type==="icon"){const d=((m=l.config)==null?void 0:m.icons)??[];return e.jsxs("select",{className:"gradebook__cell-select",value:v??"",onChange:h=>c(r,l.id,h),children:[e.jsx("option",{value:"",children:"Selecciona"}),d.map(h=>e.jsxs("option",{value:h.value,children:[h.value," ",h.label]},h.value))]})}return e.jsx("span",{children:ne(l,v)})},I=r=>e.jsx("button",{type:"button",className:`gradebook__tab ${r.id===t?"gradebook__tab--active":""}`,onClick:()=>n(r.id),children:r.label},r.id);return g?e.jsx("section",{className:"gradebook",children:"Sincronizando cuaderno..."}):e.jsxs("section",{className:"gradebook",children:[j?e.jsx("div",{className:"app-shell__notice",children:j}):null,e.jsxs("header",{className:"gradebook__header",children:[e.jsx("div",{className:"gradebook__tabs",children:s.map(I)}),e.jsxs("div",{className:"gradebook__metrics",children:[e.jsx("span",{className:"gradebook__metric-label",children:"Total alumnos"}),e.jsx("strong",{children:a.length})]}),u?e.jsx("span",{className:"gradebook__metric-hint",children:"Guardando cambios..."}):null]}),e.jsx("div",{className:"gradebook__table-wrapper",children:e.jsxs("table",{className:"gradebook__table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Alumno"}),x.columns.map(r=>e.jsx("th",{children:e.jsxs("div",{className:"gradebook__column-header",children:[e.jsx("span",{children:r.label}),r.weight?e.jsxs("small",{children:[Math.round(r.weight*100),"%"]}):null]})},r.id)),e.jsx("th",{children:"Promedio"})]})}),e.jsx("tbody",{children:a.map(r=>e.jsxs("tr",{children:[e.jsx("td",{className:"gradebook__student",children:r.displayName}),x.columns.map(l=>e.jsx("td",{children:b(r.studentId,l)},l.id)),e.jsx("td",{className:"gradebook__average",children:y(r.studentId)})]},r.studentId))})]})}),x.notes?e.jsx("p",{className:"gradebook__notes",children:x.notes}):null]})},T=["#0088FE","#00C49F","#FFBB28","#FF8042"],me=({currentUser:i,viewStudentProfile:s})=>{const[t,n]=f.useState([]),[a,p]=f.useState(!1);f.useEffect(()=>{(async()=>{const u=await W(i.id);n(u.sort((j,x)=>new Date(x.date).getTime()-new Date(j.date).getTime()))})()},[i.id]);const N=g=>{n(u=>[g,...u]),p(!1)},_=g=>{n(u=>u.map(j=>j.id===g.id?g:j))},y=f.useMemo(()=>{const g=t.reduce((c,b)=>(c[b.type]=(c[b.type]||0)+1,c),{}),u=Object.entries(g).map(([c,b])=>({name:c,value:b})),j=t.reduce((c,b)=>(c[b.status]=(c[b.status]||0)+1,c),{}),x=Object.entries(j).map(([c,b])=>({name:c,value:b}));return{typeData:u,statusData:x}},[t]);return e.jsxs("div",{className:"space-y-8",children:[e.jsx(re,{teacherId:i.id}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Mi Panel"}),e.jsxs("button",{onClick:()=>p(!a),className:"flex items-center bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors",children:[e.jsx(q,{className:"h-5 w-5 mr-2"}),a?"Cancelar Reporte":"Nuevo Reporte"]})]}),a&&e.jsx("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg animate-fade-in-down",children:e.jsx(X,{currentUser:i,onReportSubmit:N})}),t.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-semibold flex items-center mb-4 text-gray-700 dark:text-gray-300",children:[e.jsx(H,{className:"h-6 w-6 mr-2"}),"Mis Estadísticas"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md h-64",children:[e.jsx("h4",{className:"font-semibold mb-2 text-center",children:"Mis Reportes por Tipo"}),e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(O,{children:[e.jsx(V,{data:y.typeData,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",innerRadius:40,outerRadius:60,fill:"#8884d8",paddingAngle:5,label:!0,children:y.typeData.map((g,u)=>e.jsx(P,{fill:T[u%T.length]},`cell-${u}`))}),e.jsx(A,{})]})})]}),e.jsxs("div",{className:"p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md h-64",children:[e.jsx("h4",{className:"font-semibold mb-2 text-center",children:"Mis Reportes por Estado"}),e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(O,{children:[e.jsx(V,{data:y.statusData,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",innerRadius:40,outerRadius:60,fill:"#82ca9d",paddingAngle:5,label:!0,children:y.statusData.map((g,u)=>e.jsx(P,{fill:T.slice(2)[u%T.length]},`cell-${u}`))}),e.jsx(A,{})]})})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-semibold flex items-center mb-4 text-gray-700 dark:text-gray-300",children:[e.jsx(Q,{className:"h-6 w-6 mr-2"}),"Historial de Reportes Enviados"]}),t.length>0?e.jsx("div",{className:"space-y-4",children:t.map(g=>e.jsx(Y,{report:g,viewStudentProfile:s,onReportUpdate:_,currentUser:i},g.id))}):e.jsx("div",{className:"text-center py-10 px-6 bg-white dark:bg-gray-800 rounded-lg shadow-md",children:e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No has enviado ningún reporte todavía."})})]})]})};export{me as default};
