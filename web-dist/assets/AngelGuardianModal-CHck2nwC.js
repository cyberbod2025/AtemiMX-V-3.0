import{r as i,j as e}from"./react-vendor-BfikQoQB.js";import"./vendor-CUhUAKZ9.js";const k="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";class P{constructor(n={}){var o;this.apiKey=((o=n.apiKey)==null?void 0:o.trim())??"",this.fetcher=n.fetcher??fetch}async generateStructuredSummary(n,o={}){const l=n.trim();if(!l)throw new Error("Necesitamos texto antes de pedir ayuda a la IA. Repite la grabación.");if(!this.apiKey)throw new Error("Falta la API key de Gemini. Configura VITE_GEMINI_API_KEY en tu .env.");const s=await this.fetcher(`${k}?key=${encodeURIComponent(this.apiKey)}`,{method:"POST",signal:o.signal,headers:{"Content-Type":"application/json"},body:JSON.stringify(this.buildRequestBody(l))});if(!s.ok)throw new Error(`Gemini respondió ${s.status}. Revisa la clave o inténtalo más tarde.`);const c=await s.json(),a=this.extractText(c);try{const u=JSON.parse(a);if(!u.title||!u.summary)throw new Error("Respuesta incompleta de Gemini.");return{...u,rawText:a}}catch{throw new Error("Gemini envió un formato inesperado. Pide otro intento o ajusta el prompt.")}}buildRequestBody(n){return{contents:[{parts:[{text:`${["Lee la transcripción de un incidente escolar y redacta un reporte objetivo en español.",'Devuelve un objeto JSON con las propiedades "title" y "summary".',"El resumen debe centrarse en hechos observables y sugerir próximos pasos breves."].join(" ")}

TRANSCRIPCIÓN:
"${n}"`}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"object",properties:{title:{type:"string"},summary:{type:"string"}},required:["title","summary"]}}}}extractText(n){var o,l,s;if(typeof n=="string")return n;if(n&&typeof n=="object"&&"candidates"in n&&Array.isArray(n.candidates)){const c=n.candidates[0],a=(s=(l=(o=c==null?void 0:c.content)==null?void 0:o.parts)==null?void 0:l[0])==null?void 0:s.text;if(typeof a=="string")return a}throw new Error("No se pudo interpretar la respuesta de Gemini.")}}const v=typeof window<"u"?window.SpeechRecognition||window.webkitSpeechRecognition:null,$=!!v,F=new P({apiKey:""}),D=({onClose:f,onSaveReport:n,onSaved:o})=>{const[l,s]=i.useState("idle"),[c,a]=i.useState(null),[u,j]=i.useState(""),[g,w]=i.useState(""),[p,y]=i.useState(null),m=i.useRef(null),[E,N]=i.useState(0),x=i.useRef(null),[b,R]=i.useState(!1);i.useEffect(()=>{if(!$){a("Tu navegador no soporta el reconocimiento de voz. Por favor, intenta con Google Chrome.");return}const t=v?new v:null;if(!t){a("Tu navegador no expone la API de voz.");return}return t.continuous=!0,t.interimResults=!0,t.lang="es-MX",t.onresult=r=>{let d="",I="";for(let h=0;h<r.results.length;++h)r.results[h].isFinal?d+=r.results[h][0].transcript:I+=r.results[h][0].transcript;w(d),j(d+I)},t.onerror=r=>{a(`Error de reconocimiento: ${r.error}`),S()},m.current=t,()=>{t.stop(),x.current&&clearInterval(x.current)}},[]);const C=()=>{if(j(""),w(""),N(0),a(null),m.current)try{m.current.start(),s("recording"),x.current=window.setInterval(()=>N(t=>t+1),1e3)}catch{a("La grabación no pudo iniciar. Intenta de nuevo.")}},S=async()=>{m.current&&m.current.stop(),x.current&&clearInterval(x.current),s("processing");try{const t=await F.generateStructuredSummary(g);y({title:t.title,summary:t.summary}),s("review")}catch(t){console.error(t),a(t instanceof Error?t.message:"Error al generar el reporte con la IA. Por favor, intenta de nuevo."),s("idle")}},G=async()=>{if(!p)return;const t=g.trim();if(!t){a("No hay transcripción final para guardar.");return}R(!0);try{const r={title:p.title.trim()||"Reporte sin título",summary:p.summary.trim(),transcript:t,date:new Date().toISOString()},d=await n(r);o==null||o(d),f()}catch(r){console.error("[AngelGuardian] No se pudo guardar el reporte cifrado",r),a(r instanceof Error?r.message:"No fue posible guardar el reporte. Intenta de nuevo."),s("review")}finally{R(!1)}},T=t=>{const r=Math.floor(t/60).toString().padStart(2,"0"),d=(t%60).toString().padStart(2,"0");return`${r}:${d}`},A=()=>{if(c)return e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-bold font-display text-[var(--error)] mb-4",children:"Ocurrió un Error"}),e.jsx("p",{className:"text-gray-300",children:c}),e.jsx("button",{className:"btn btn-secondary mt-6",onClick:f,children:"Cerrar"})]});switch(l){case"idle":return e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold font-display text-[var(--accent-1)] mb-4",children:"Activar Ángel Guardián"}),e.jsx("p",{className:"text-gray-300 mb-6",children:"La grabación se transcribe en tu navegador y se cifra con AES-GCM antes de enviarse a Firestore. Solo tu sesión autenticada puede descifrarlo nuevamente."}),e.jsx("button",{className:"btn btn-primary w-full",onClick:C,children:"Comenzar Grabación"})]});case"recording":return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-center mb-4",children:[e.jsx("div",{className:"w-4 h-4 rounded-full bg-[var(--error)] animate-pulse mr-3"}),e.jsxs("h2",{className:"text-xl sm:text-2xl font-bold font-display text-[var(--error)]",children:["Grabando... ",T(E)]})]}),e.jsx("p",{className:"text-gray-300 bg-black/30 p-4 rounded-lg min-h-[150px] max-h-[300px] overflow-y-auto",children:u||"Escuchando..."}),e.jsx("button",{className:"btn btn-secondary w-full mt-6 !border-[var(--error)] hover:!bg-[var(--error)]",onClick:S,children:"Detener y Generar Reporte"})]});case"processing":return e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-lg text-[var(--accent-1)]",children:"Procesando y generando reporte con IA..."})});case"review":return e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold font-display text-[var(--accent-1)] mb-4",children:"Revisar Reporte"}),p&&e.jsxs("div",{className:"space-y-4 max-h-[60vh] overflow-y-auto pr-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"font-bold text-gray-400",children:"Título Sugerido"}),e.jsx("input",{type:"text",className:"input-field mt-1",value:p.title,onChange:t=>y(r=>r?{...r,title:t.target.value}:null)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-bold text-gray-400",children:"Resumen por IA"}),e.jsx("textarea",{className:"input-field mt-1 h-24",value:p.summary,onChange:t=>y(r=>r?{...r,summary:t.target.value}:null)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-gray-400 mb-1",children:"Transcripción Completa"}),e.jsx("p",{className:"text-sm text-gray-300 bg-black/30 p-2 rounded-md whitespace-pre-wrap",children:g})]})]}),e.jsxs("div",{className:"flex gap-4 mt-6",children:[e.jsx("button",{className:"btn btn-primary flex-1 disabled:opacity-60",onClick:G,disabled:b,children:b?"Guardando...":"Guardar Reporte"}),e.jsx("button",{className:"btn btn-secondary flex-1",onClick:()=>s("idle"),disabled:b,children:"Descartar"})]})]})}};return e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4",style:{animation:"fadeIn 0.3s ease-out"},role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"bg-surface-800/60 backdrop-blur-lg border border-[var(--accent-2)]/50 rounded-2xl p-6 sm:p-8 w-full max-w-2xl shadow-2xl shadow-[var(--accent-1)]/10",style:{animation:"slideInUp 0.3s ease-out"},children:[e.jsx("button",{onClick:f,className:"absolute top-4 right-4 text-gray-400 hover:text-white",children:"×"}),A()]})})};export{D as default};
