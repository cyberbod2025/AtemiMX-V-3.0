import{d as D,g as U,a as w,s as X,M as Q,r as g,j as e,c as K,q as W,o as Y,w as Z,b as ee,e as ae,u as te,f as se,h as ne,D as re,C as ie,i as le}from"./index-B93U3tDT.js";import{R as oe}from"./ReportForm-DF3a5ZuU.js";import{R as ce}from"./ReportCard-C8iLMip1.js";import{R as F,C as G,T as B}from"./CategoricalChart-B_SJ7qfj.js";import{P as q,a as V}from"./PieChart-D_AgBBzO.js";import"./geminiService-fkZN5fdV.js";const $="gradebooks",de=async s=>{const n=D(w,$,s),t=await U(n);return t.exists()?t.data():null},ue=async(s,n)=>{const t=D(w,$,s);await X(t,n,{merge:!0})},M=[{min:0,max:5.9,bg:"#fee2e2",fg:"#991b1b"},{min:6,max:7.9,bg:"#fef9c3",fg:"#92400e"},{min:8,max:10,bg:"#dcfce7",fg:"#14532d"}],me=()=>{const s=Q.map(r=>({studentId:r.id,displayName:r.name})),n=[{id:"unidad1",label:"Unidad 1 · Diagnóstico",columns:[{id:"diag",label:"Diagnóstico (10)",type:"numeric",weight:.2,config:{min:0,max:10,colorRules:M}},{id:"participacion",label:"Participación",type:"icon",weight:.1,config:{icons:[{value:"⭐️",label:"Sobresaliente",points:10},{value:"✅",label:"Cumple",points:8},{value:"⚠️",label:"Atender",points:6}]}},{id:"producto1",label:"Producto integrador",type:"numeric",weight:.4,config:{min:0,max:100,colorRules:M}},{id:"resumen",label:"Resumen autoevaluación",type:"text"},{id:"promedio_u1",label:"Promedio U1",type:"formula",config:{formula:"average",fromColumns:["diag","producto1"]}}]},{id:"unidad2",label:"Unidad 2 · Proyecto",columns:[{id:"investigacion",label:"Investigación",type:"numeric",weight:.35,config:{min:0,max:10,colorRules:M}},{id:"rubrica",label:"Rúbrica Equipo",type:"numeric",weight:.35,config:{min:0,max:4,colorRules:[{min:0,max:1.9,bg:"#fee2e2",fg:"#991b1b"},{min:2,max:2.9,bg:"#fef9c3",fg:"#92400e"},{min:3,max:4,bg:"#dcfce7",fg:"#14532d"}]}},{id:"badgeMaker",label:"Insignias",type:"formula",config:{formula:"badgeMaker",fromColumns:["participacion"]}}]}],t=(r,c,m)=>({studentId:r,columnId:c,value:m}),i={};return s.forEach((r,c)=>{i[r.studentId]={},i[r.studentId].diag=t(r.studentId,"diag",6+c%5),i[r.studentId].participacion=t(r.studentId,"participacion",c%2===0?"⭐️":"✅"),i[r.studentId].producto1=t(r.studentId,"producto1",70+c*3),i[r.studentId].resumen=t(r.studentId,"resumen","Entrega puntual y participa."),i[r.studentId].investigacion=t(r.studentId,"investigacion",7+c%3),i[r.studentId].rubrica=t(r.studentId,"rubrica",2+c%3)}),{tabs:n,rows:s,cells:i}},pe=(s={})=>{var k;const{teacherId:n}=s,t=g.useMemo(()=>me(),[]),[i,r]=g.useState(t),[c,m]=g.useState(((k=i.tabs[0])==null?void 0:k.id)??"unidad1"),[N,y]=g.useState(!!n),[x,a]=g.useState(!1),[l,b]=g.useState(null),o=g.useRef(null),j=g.useRef(null);g.useEffect(()=>{if(!n){y(!1),r(t);return}y(!0),de(n).then(u=>{var f;u?(r(u),m(((f=u.tabs[0])==null?void 0:f.id)??"unidad1")):r(t),b(null)}).catch(u=>{console.error("[Gradebook] No se pudo cargar el cuaderno",u),b("No pudimos sincronizar el cuaderno. Mostramos una versión local."),r(t)}).finally(()=>y(!1))},[t,n]),g.useEffect(()=>()=>{o.current&&clearTimeout(o.current)},[]);const T=u=>{n&&(j.current=u,o.current&&clearTimeout(o.current),o.current=setTimeout(async()=>{if(j.current){a(!0);try{await ue(n,j.current),b(null)}catch(f){console.error("[Gradebook] No se pudo guardar el cuaderno",f),b("No pudimos guardar los cambios. Revisa tu conexión.")}finally{a(!1)}}},800))},d=(u,f,h)=>{r(v=>{const C=JSON.parse(JSON.stringify(v));return C.cells[u]||(C.cells[u]={}),C.cells[u][f]={studentId:u,columnId:f,value:h},T(C),C})},p=(u,f)=>{var h,v;return((v=(h=i.cells[u])==null?void 0:h[f])==null?void 0:v.value)??null},_=(u,f)=>{const h=p(u,f);return typeof h=="number"?h:typeof h=="string"&&h.trim().length>0&&!Number.isNaN(Number(h))?Number(h):null},R=(u,f=c)=>{const h=i.tabs.find(S=>S.id===f);if(!h)return 0;const v=h.columns.filter(S=>S.type!=="text"),C=v.reduce((S,I)=>{const A=_(u,I.id);if(A===null)return S;const J=I.weight??1;return S+A*J},0),H=v.reduce((S,I)=>S+(I.weight??1),0)||1;return Number((C/H).toFixed(2))},P=u=>{if(i.rows.length===0)return 0;const f=i.rows.reduce((h,v)=>h+R(v.studentId,u),0);return Number((f/i.rows.length).toFixed(2))};return{tabs:i.tabs,activeTabId:c,setActiveTabId:m,rows:i.rows,getValue:p,getNumericValue:_,updateCell:d,getAverageForStudent:R,getTabAverage:P,model:i,loading:N,saving:x,error:l}},he=(s,n)=>{var i;if(!((i=s.config)!=null&&i.colorRules)||n===null)return{};const t=s.config.colorRules.find(r=>n>=r.min&&n<=r.max);return t?{backgroundColor:t.bg,color:t.fg}:{}},ge=(s,n)=>{var t;return n==null||n===""?"—":s.type==="numeric"&&typeof n=="number"?n.toFixed((t=s.config)!=null&&t.max&&s.config.max<=5?1:0):n},xe=({teacherId:s})=>{const{tabs:n,activeTabId:t,setActiveTabId:i,rows:r,getValue:c,getNumericValue:m,updateCell:N,getAverageForStudent:y,loading:x,saving:a,error:l}=pe({teacherId:s}),b=n.find(d=>d.id===t)??n[0];if(!b)return null;const o=(d,p,_)=>{N(d,p,_.target.value)},j=(d,p)=>{var k,u,f;const _=c(d,p.id),R=m(d,p.id),P=p.type==="numeric"?he(p,R):void 0;if(p.type==="numeric")return e.jsx("input",{type:"number",className:"gradebook__cell-input",value:_??"",onChange:h=>o(d,p.id,h),min:((k=p.config)==null?void 0:k.min)??0,max:((u=p.config)==null?void 0:u.max)??100,style:P});if(p.type==="text")return e.jsx("textarea",{className:"gradebook__cell-text",value:_??"",onChange:h=>o(d,p.id,h)});if(p.type==="icon"){const h=((f=p.config)==null?void 0:f.icons)??[];return e.jsxs("select",{className:"gradebook__cell-select",value:_??"",onChange:v=>o(d,p.id,v),children:[e.jsx("option",{value:"",children:"Selecciona"}),h.map(v=>e.jsxs("option",{value:v.value,children:[v.value," ",v.label]},v.value))]})}return e.jsx("span",{children:ge(p,_)})},T=d=>e.jsx("button",{type:"button",className:`gradebook__tab ${d.id===t?"gradebook__tab--active":""}`,onClick:()=>i(d.id),children:d.label},d.id);return x?e.jsx("section",{className:"gradebook",children:"Sincronizando cuaderno..."}):e.jsxs("section",{className:"gradebook",children:[l?e.jsx("div",{className:"app-shell__notice",children:l}):null,e.jsxs("header",{className:"gradebook__header",children:[e.jsx("div",{className:"gradebook__tabs",children:n.map(T)}),e.jsxs("div",{className:"gradebook__metrics",children:[e.jsx("span",{className:"gradebook__metric-label",children:"Total alumnos"}),e.jsx("strong",{children:r.length})]}),a?e.jsx("span",{className:"gradebook__metric-hint",children:"Guardando cambios..."}):null]}),e.jsx("div",{className:"gradebook__table-wrapper",children:e.jsxs("table",{className:"gradebook__table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Alumno"}),b.columns.map(d=>e.jsx("th",{children:e.jsxs("div",{className:"gradebook__column-header",children:[e.jsx("span",{children:d.label}),d.weight?e.jsxs("small",{children:[Math.round(d.weight*100),"%"]}):null]})},d.id)),e.jsx("th",{children:"Promedio"})]})}),e.jsx("tbody",{children:r.map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"gradebook__student",children:d.displayName}),b.columns.map(p=>e.jsx("td",{children:j(d.studentId,p)},p.id)),e.jsx("td",{className:"gradebook__average",children:y(d.studentId)})]},d.studentId))})]})}),b.notes?e.jsx("p",{className:"gradebook__notes",children:b.notes}):null]})},O="plannerEntries",be=async s=>{const n=K(w,O),t=W(n,Z("teacherId","==",s),Y("dateISO","asc"));return(await ee(t)).docs.map(r=>r.data())},fe=async s=>{const n=K(w,O),t={...s,updatedAtISO:new Date().toISOString()},i=await se(n,t);return{...t,id:i.id}},je=async(s,n)=>{const t=D(w,O,s);await te(t,{...n,updatedAtISO:new Date().toISOString()})},ve=async s=>{const n=D(w,O,s);await ae(n)},ye=({teacherId:s})=>{const[n,t]=g.useState([]),[i,r]=g.useState(!!s),[c,m]=g.useState(null);return g.useEffect(()=>{if(!s){t([]),r(!1);return}r(!0),be(s).then(a=>{t(a),m(null)}).catch(a=>{console.error("[Planner] No se pudieron cargar las planeaciones",a),m("No pudimos sincronizar tu planner. Mostramos la vista local.")}).finally(()=>r(!1))},[s]),{entries:n,loading:i,error:c,addEntry:async a=>{if(!s)return;const l=await fe({...a,teacherId:s});t(b=>[...b,l].sort((o,j)=>o.dateISO.localeCompare(j.dateISO)))},updateEntry:async(a,l)=>{s&&(await je(a,l),t(b=>b.map(o=>o.id===a?{...o,...l,updatedAtISO:new Date().toISOString()}:o)))},removeEntry:async a=>{s&&(await ve(a),t(l=>l.filter(b=>b.id!==a)))}}},L=s=>{try{return new Intl.DateTimeFormat("es-MX",{dateStyle:"long"}).format(new Date(s))}catch{return s}},z={teacherId:"",dateISO:new Date().toISOString().split("T")[0],subject:"",field:"",objective:"",activities:"",resources:"",evaluationNotes:""},Ne=({teacher:s})=>{const{entries:n,loading:t,error:i,addEntry:r}=ye({teacherId:s.id}),[c,m]=g.useState({...z,teacherId:s.id}),[N,y]=g.useState(!1),x=async a=>{a.preventDefault(),y(!0);try{await r(c),m({...z,teacherId:s.id})}catch(l){console.error("[Planner] no se pudo guardar la planeación",l)}finally{y(!1)}};return e.jsxs("section",{className:"planner",children:[e.jsxs("header",{className:"planner__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"planner__eyebrow",children:"Planner Atemi"}),e.jsx("h3",{children:"Registro semanal"})]}),t?e.jsx("span",{className:"planner__status",children:"Sincronizando..."}):null,N?e.jsx("span",{className:"planner__status",children:"Guardando..."}):null]}),i?e.jsx("div",{className:"app-shell__notice",children:i}):null,e.jsxs("form",{className:"planner__form",onSubmit:x,children:[e.jsxs("div",{className:"planner__form-grid",children:[e.jsxs("label",{children:["Fecha",e.jsx("input",{type:"date",required:!0,value:c.dateISO,onChange:a=>m(l=>({...l,dateISO:a.target.value}))})]}),e.jsxs("label",{children:["Campo Formativo",e.jsx("input",{type:"text",required:!0,placeholder:"Ej. Saberes y Pensamiento Científico",value:c.field,onChange:a=>m(l=>({...l,field:a.target.value}))})]}),e.jsxs("label",{children:["Asignatura / Proyecto",e.jsx("input",{type:"text",required:!0,placeholder:"Matemáticas, Proyecto 2",value:c.subject,onChange:a=>m(l=>({...l,subject:a.target.value}))})]})]}),e.jsxs("label",{children:["Objetivo de la sesión",e.jsx("textarea",{required:!0,placeholder:"Describe el objetivo o propósito de aprendizaje...",value:c.objective,onChange:a=>m(l=>({...l,objective:a.target.value}))})]}),e.jsxs("label",{children:["Actividades clave",e.jsx("textarea",{required:!0,placeholder:"Secuencia de actividades, integración NEM, atención a la diversidad...",value:c.activities,onChange:a=>m(l=>({...l,activities:a.target.value}))})]}),e.jsxs("label",{children:["Recursos",e.jsx("textarea",{placeholder:"Materiales, tecnología, recursos Atemi...",value:c.resources,onChange:a=>m(l=>({...l,resources:a.target.value}))})]}),e.jsxs("label",{children:["Observaciones / Evaluación formativa",e.jsx("textarea",{placeholder:"Notas rápidas para reforzar la autoevaluación y coevaluación...",value:c.evaluationNotes,onChange:a=>m(l=>({...l,evaluationNotes:a.target.value}))})]}),e.jsx("button",{type:"submit",className:"planner__submit",disabled:N,children:N?"Guardando...":"Guardar planeación"})]}),e.jsxs("div",{className:"planner__list",children:[n.map(a=>e.jsxs("article",{className:"planner__card",children:[e.jsxs("header",{children:[e.jsx("span",{className:"planner__date",children:L(a.dateISO)}),e.jsx("h4",{children:a.subject}),e.jsx("p",{className:"planner__field",children:a.field})]}),e.jsxs("div",{className:"planner__body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Objetivo:"})," ",a.objective]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Actividades:"})," ",a.activities]}),a.resources?e.jsxs("p",{children:[e.jsx("strong",{children:"Recursos:"})," ",a.resources]}):null,a.evaluationNotes?e.jsxs("p",{children:[e.jsx("strong",{children:"Observaciones:"})," ",a.evaluationNotes]}):null]}),e.jsx("footer",{children:e.jsxs("small",{children:["Última actualización: ",L(a.updatedAtISO)]})})]},a.id)),n.length===0&&!t?e.jsx("p",{className:"planner__empty",children:"Aún no tienes planeaciones registradas."}):null]})]})},E=["#0088FE","#00C49F","#FFBB28","#FF8042"],Ie=({currentUser:s,viewStudentProfile:n})=>{const[t,i]=g.useState([]),[r,c]=g.useState(!1),m=g.useCallback(async()=>{const x=await ne(s.id);i(x.sort((a,l)=>new Date(l.date).getTime()-new Date(a.date).getTime()))},[s.id]);g.useEffect(()=>{m()},[m]);const N=x=>{i(a=>a.map(l=>l.id===x.id?x:l))},y=g.useMemo(()=>{const x=t.reduce((o,j)=>(o[j.type]=(o[j.type]||0)+1,o),{}),a=Object.entries(x).map(([o,j])=>({name:o,value:j})),l=t.reduce((o,j)=>(o[j.status]=(o[j.status]||0)+1,o),{}),b=Object.entries(l).map(([o,j])=>({name:o,value:j}));return{typeData:a,statusData:b}},[t]);return e.jsxs("div",{className:"space-y-8",children:[e.jsx(xe,{teacherId:s.id}),e.jsx(Ne,{teacher:s}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Mi Panel"}),e.jsxs("button",{onClick:()=>c(!r),className:"flex items-center bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors",children:[e.jsx(re,{className:"h-5 w-5 mr-2"}),r?"Cancelar Reporte":"Nuevo Reporte"]})]}),r&&e.jsx("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg animate-fade-in-down",children:e.jsx(oe,{currentUser:s,onCreated:()=>{c(!1),m()}})}),t.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-semibold flex items-center mb-4 text-gray-700 dark:text-gray-300",children:[e.jsx(ie,{className:"h-6 w-6 mr-2"}),"Mis Estadísticas"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md h-64",children:[e.jsx("h4",{className:"font-semibold mb-2 text-center",children:"Mis Reportes por Tipo"}),e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(q,{children:[e.jsx(V,{data:y.typeData,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",innerRadius:40,outerRadius:60,fill:"#8884d8",paddingAngle:5,label:!0,children:y.typeData.map((x,a)=>e.jsx(G,{fill:E[a%E.length]},`cell-${a}`))}),e.jsx(B,{})]})})]}),e.jsxs("div",{className:"p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md h-64",children:[e.jsx("h4",{className:"font-semibold mb-2 text-center",children:"Mis Reportes por Estado"}),e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(q,{children:[e.jsx(V,{data:y.statusData,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",innerRadius:40,outerRadius:60,fill:"#82ca9d",paddingAngle:5,label:!0,children:y.statusData.map((x,a)=>e.jsx(G,{fill:E.slice(2)[a%E.length]},`cell-${a}`))}),e.jsx(B,{})]})})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-semibold flex items-center mb-4 text-gray-700 dark:text-gray-300",children:[e.jsx(le,{className:"h-6 w-6 mr-2"}),"Historial de Reportes Enviados"]}),t.length>0?e.jsx("div",{className:"space-y-4",children:t.map(x=>e.jsx(ce,{report:x,viewStudentProfile:n,onReportUpdate:N,currentUser:s},x.id))}):e.jsx("div",{className:"text-center py-10 px-6 bg-white dark:bg-gray-800 rounded-lg shadow-md",children:e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No has enviado ningún reporte todavía."})})]})]})};export{Ie as default};
