import{t as u,u as R,w as E,v as g,T as s,D as h,n as b,B as N}from"./firebase-Bi_eiI5S.js";import{d,e as A,g as D}from"./index-BE3S3omL.js";import{a as L,s as n,Z as S}from"./vendor-CUhUAKZ9.js";const F=e=>!Number.isNaN(Date.parse(e)),w=L({title:n({required_error:"El titulo es obligatorio."}).trim().min(3,{message:"El titulo debe tener al menos 3 caracteres."}).max(120,{message:"El titulo debe tener maximo 120 caracteres."}),description:n({required_error:"La descripcion es obligatoria."}).trim().min(10,{message:"La descripcion debe tener al menos 10 caracteres."}).max(2e3,{message:"La descripcion debe tener maximo 2000 caracteres."}),date:n({required_error:"La fecha es obligatoria."}).trim().refine(F,{message:"La fecha debe tener un formato valido (YYYY-MM-DD)."}),category:n({required_error:"La categoria es obligatoria."}).trim().min(3,{message:"La categoria debe tener al menos 3 caracteres."}).max(50,{message:"La categoria debe tener maximo 50 caracteres."}),uid:n({required_error:"El identificador de usuario es obligatorio."}).trim().min(1,{message:"El identificador de usuario es obligatorio."})}),l="reports";w.omit({uid:!0}).partial();const O=e=>{const t=e.errors[0];return`Datos de reporte invalidos: ${(t==null?void 0:t.message)??"verifica la informacion ingresada."}`},x=e=>{try{return w.parse(e)}catch(t){throw t instanceof S?new Error(O(t)):t}},M=e=>s.fromDate(new Date(e)),m=e=>{const t=e==null?void 0:e.trim();return t&&t.length>0?t:null},P=(e,t)=>{var r;return{title:e.title,description:e.description,category:e.category,dateISO:e.date,ownerName:m(t==null?void 0:t.name)??null,ownerEmail:m((r=t==null?void 0:t.email)==null?void 0:r.toLowerCase())??null,ownerRole:m(t==null?void 0:t.role)??null}},T=async e=>e.payload&&typeof e.payload=="object"?A(e.payload):{title:typeof e.title=="string"?e.title:"",description:typeof e.description=="string"?e.description:"",category:typeof e.category=="string"?e.category:"",dateISO:typeof e.date=="string"?e.date:e.date instanceof s?e.date.toDate().toISOString():"",ownerName:typeof e.ownerName=="string"?e.ownerName:null,ownerEmail:typeof e.ownerEmail=="string"?e.ownerEmail:null,ownerRole:typeof e.ownerRole=="string"?e.ownerRole:null},Y=async(e,t)=>{const r=x(e),a=s.now(),o=P(r,t),c=await D(o),p=u(d,l),i={uid:r.uid,date:M(r.date),createdAt:a,updatedAt:a,payload:c,encryptionVersion:c.version};try{return{id:(await h(p,i)).id,uid:i.uid,title:o.title,description:o.description,category:o.category,date:i.date,createdAt:i.createdAt,updatedAt:i.updatedAt,ownerName:o.ownerName,ownerEmail:o.ownerEmail,ownerRole:o.ownerRole}}catch(y){throw console.error("[Firestore] Failed to create report:",y),new Error("No se pudo crear el reporte en Firestore.")}},f=async e=>{const t=e.data(),r=await T(t);return{id:e.id,uid:typeof t.uid=="string"?t.uid:"",title:r.title,description:r.description,category:r.category,date:t.date??s.now(),createdAt:t.createdAt??s.now(),updatedAt:t.updatedAt??s.now(),ownerName:r.ownerName,ownerEmail:r.ownerEmail,ownerRole:r.ownerRole}},v=async e=>{try{const t=u(d,l),r=R(t,E("uid","==",e)),a=await g(r);return(await Promise.all(a.docs.map(f))).sort((c,p)=>p.updatedAt.toMillis()-c.updatedAt.toMillis())}catch(t){throw console.error("[Firestore] Failed to fetch reports for user:",t),new Error("No se pudieron obtener los reportes del usuario.")}},C=async()=>{try{const e=u(d,l),t=await g(e);return(await Promise.all(t.docs.map(f))).sort((a,o)=>o.updatedAt.toMillis()-a.updatedAt.toMillis())}catch(e){throw console.error("[Firestore] Failed to fetch all reports:",e),new Error("No se pudieron obtener los reportes registrados.")}},V=async e=>{try{const t=b(d,l,e);await N(t)}catch(t){throw console.error(`[Firestore] Failed to delete report (${e}):`,t),new Error("No se pudo eliminar el reporte.")}};export{C as a,Y as c,V as d,v as g};
