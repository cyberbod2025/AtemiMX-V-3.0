import{d as y,u as C,L as P,c as q,q as G,o as K,b as V,a as p,s as W,N as w,r as o,j as e,S as Q,y as X,M as Y,p as Z,O as A,R as i,U as E,P as z,Q as J,T as ee,V as se,W as ae,X as te,Y as T,Z as ne,_ as de}from"./index-B93U3tDT.js";const v="incidentMetadata",xe=async s=>{const n=y(p,v,s.id);await W(n,{...s,updatedAtServer:w()},{merge:!0})},he=async()=>{const s=q(p,v),n=G(s,K("date","desc"));return(await V(n)).docs.map(t=>t.data())},re=async(s,n)=>{const d=y(p,v,s);await C(d,{comments:P(n),updatedAtServer:w()})},ce=async(s,n)=>{const d=y(p,v,s);await C(d,{evidence:P(n),updatedAtServer:w()})},le=async(s,n,d)=>{const t=y(p,v,s);await C(t,{status:n,resolutionNotes:d??null,updatedAtServer:w()})},ie=({onRecordingComplete:s})=>{const[n,d]=o.useState(!1),t=o.useRef(null),l=o.useRef([]),c=o.useRef(null),r=()=>{t.current&&t.current.state==="recording"&&t.current.stop(),c.current&&(c.current.getTracks().forEach(m=>m.stop()),c.current=null),d(!1)},u=async()=>{try{const m=await navigator.mediaDevices.getUserMedia({audio:!0});c.current=m;const x=new MediaRecorder(m);t.current=x,l.current=[],x.ondataavailable=h=>{l.current.push(h.data)},x.onstop=()=>{var b;const h=((b=t.current)==null?void 0:b.mimeType)||"audio/webm",f=new Blob(l.current,{type:h});s(f),l.current=[]},x.start(),d(!0)}catch(m){console.error("Could not start recording:",m),alert("No se pudo acceder al micrófono. Por favor, verifica los permisos.")}},g=()=>{n?r():u()};return e.jsx("button",{type:"button",onClick:g,className:`flex items-center text-sm px-3 py-1 rounded transition-colors ${n?"bg-red-500 text-white hover:bg-red-600":"bg-gray-200 hover:bg-gray-300"}`,children:n?e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-4 w-4 mr-1"}),"Detener"]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"Grabar Audio"]})})},oe=({report:s,student:n,teacher:d})=>{var c;const t=Y.find(r=>r.id===s.studentId),l=((c=Z.find(r=>r.id===s.resolvedById))==null?void 0:c.name)||"N/A";return e.jsxs("div",{className:"p-8 font-sans bg-white text-gray-900",children:[e.jsxs("header",{className:"text-center mb-8 border-b-2 pb-4 border-gray-900",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Reporte de Incidencia Escolar"}),e.jsx("p",{className:"text-lg",children:'Secundaria Técnica No. 310 "Atemi"'})]}),e.jsxs("section",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Detalles del Reporte"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-8 gap-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Fecha del Reporte:"})," ",new Date(s.date).toLocaleString()]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Estado:"})," ",s.status]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Alumno:"})," ",n]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Grado y Grupo:"})," ",t==null?void 0:t.grade,'° "',t==null?void 0:t.group,'"']}),e.jsxs("div",{children:[e.jsx("strong",{children:"Reportado por:"})," ",d]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Tipo de Incidencia:"})," ",s.type]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("strong",{children:"Asignatura/Motivo:"})," ",s.subject]})]})]}),e.jsxs("section",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Descripción de Hechos"}),e.jsx("p",{className:"text-sm leading-relaxed",children:s.description})]}),e.jsxs("section",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Acciones Inmediatas"}),e.jsx("p",{className:"text-sm leading-relaxed",children:s.actionsTaken})]}),s.comments.length>0&&e.jsxs("section",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Historial de Seguimiento"}),e.jsx("div",{className:"space-y-3",children:s.comments.map(r=>e.jsxs("div",{className:"text-sm border-l-2 pl-3",children:[e.jsxs("p",{children:[e.jsx("strong",{children:r.userName})," (",new Date(r.date).toLocaleString(),")"]}),e.jsx("p",{className:"mt-1",children:r.text})]},r.id))})]}),s.status==="Resuelto"&&e.jsxs("section",{className:"mb-6 bg-gray-100 p-4 rounded",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-3",children:"Resolución del Caso"}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Fecha de Resolución:"})," ",new Date(s.resolvedDate).toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Resuelto por:"})," ",l]}),e.jsx("p",{className:"mt-2",children:e.jsx("strong",{children:"Acuerdos y Notas Finales:"})}),e.jsx("p",{className:"mt-1 leading-relaxed",children:s.resolutionNotes})]})]}),e.jsxs("footer",{className:"mt-24 pt-8",children:[e.jsx("h2",{className:"text-xl font-semibold border-b pb-2 mb-12 text-center",children:"Firmas de Enterado y Acuerdos"}),e.jsxs("div",{className:"grid grid-cols-3 gap-12 text-center text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"border-t border-gray-700 pt-2",children:"Firma del Alumno(a)"}),e.jsx("div",{className:"mt-1",children:n})]}),e.jsx("div",{children:e.jsx("div",{className:"border-t border-gray-700 pt-2",children:"Firma del Padre, Madre o Tutor"})}),e.jsxs("div",{children:[e.jsx("div",{className:"border-t border-gray-700 pt-2",children:"Firma del Personal Escolar"}),e.jsx("div",{className:"mt-1",children:l!=="N/A"?l:d})]})]})]})]})},ue=({report:s,viewStudentProfile:n,onReportUpdate:d,currentUser:t,isStudentProfileView:l})=>{const[c,r]=o.useState(!1),[u,g]=o.useState(""),[m,x]=o.useState(!1),[h,f]=o.useState(""),b=o.useRef(null);o.useEffect(()=>{const a=localStorage.getItem(`draft-comment-${s.id}`);a&&g(a)},[s.id]);const M=a=>{g(a.target.value),localStorage.setItem(`draft-comment-${s.id}`,a.target.value)},F=()=>r(!c),B=async()=>{if(u.trim()==="")return;const a={id:`c-${Date.now()}`,userId:t.id,userName:t.name,text:u,date:new Date().toISOString()};await re(s.id,a),d({...s,comments:[...s.comments,a],status:i.InProgress}),g(""),localStorage.removeItem(`draft-comment-${s.id}`)},k=async(a,j)=>{const N=new FileReader;N.readAsDataURL(a),N.onload=async()=>{const D={id:`ev-${Date.now()}`,type:j,url:N.result,fileName:j==="photo"?a.name:`grabacion-${new Date().toISOString()}.webm`,date:new Date().toISOString()};await ce(s.id,D),d({...s,evidence:[...s.evidence,D]})}},L=a=>{a.target.files&&a.target.files[0]&&k(a.target.files[0],"photo")},$=a=>{k(a,"audio")},O=async()=>{h.trim()!==""&&(await le(s.id,i.Resolved,h),d({...s,status:i.Resolved,resolutionNotes:h,resolvedById:t.id,resolvedDate:new Date().toISOString()}),x(!1),f(""))},I=s.studentName??s.studentId,S=s.teacherId,U=()=>{var j;const a=window.open("","_blank");if(a){const N=(j=document.getElementById(`printable-${s.id}`))==null?void 0:j.innerHTML;a.document.write(`<html><head><title>Reporte de Incidencia</title><script src="https://cdn.tailwindcss.com"><\/script></head><body>${N}</body></html>`),a.document.close(),setTimeout(()=>{a.print()},500)}},H=s.resolvedById??"Desconocido",R=[A.Guidance,A.Admin].includes(t.role),_={[i.New]:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300",[i.InProgress]:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300",[i.Resolved]:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300"};return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden",children:[e.jsx("div",{className:"p-4 cursor-pointer",onClick:F,children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-lg text-gray-800 dark:text-white",children:s.subject}),e.jsxs("div",{className:"flex items-center text-sm text-gray-500 dark:text-gray-400 mt-1",children:[!l&&e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"h-4 w-4 mr-1"}),e.jsx("button",{onClick:a=>{a.stopPropagation(),n(s.studentId)},className:"hover:underline font-semibold",children:I}),e.jsx("span",{className:"mx-2",children:"|"})]}),e.jsx(z,{className:"h-4 w-4 mr-1"}),e.jsx("span",{children:new Date(s.date).toLocaleDateString()})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full ${_[s.status]}`,children:s.status}),e.jsx("button",{className:"text-gray-500 hover:text-gray-700",children:c?e.jsx(J,{className:"h-5 w-5"}):e.jsx(ee,{className:"h-5 w-5"})})]})]})}),c&&e.jsxs("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 animate-fade-in-down space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"text-gray-600 dark:text-gray-300",children:"Reportado por:"})," ",S]}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-semibold flex items-center",children:[e.jsx(se,{className:"h-5 w-5 mr-2"}),"Descripción"]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:s.description})]}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-semibold flex items-center",children:[e.jsx(ae,{className:"h-5 w-5 mr-2"}),"Acciones Tomadas"]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:s.actionsTaken})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsxs("h5",{className:"font-semibold flex items-center mb-2",children:[e.jsx(te,{className:"h-5 w-5 mr-2"}),"Evidencia Adjunta"]}),e.jsx("div",{className:"space-y-2",children:s.evidence.map(a=>e.jsxs("div",{className:"flex items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md",children:[a.type==="photo"?e.jsx(T,{className:"h-5 w-5 mr-2"}):e.jsx(E,{className:"h-5 w-5 mr-2"}),e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 hover:underline text-sm",children:a.fileName})]},a.id))}),R&&s.status!==i.Resolved&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"file",accept:"image/*",ref:b,onChange:L,className:"hidden"}),e.jsxs("button",{onClick:()=>{var a;return(a=b.current)==null?void 0:a.click()},className:"flex items-center text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300",children:[e.jsx(T,{className:"h-4 w-4 mr-1"}),"Adjuntar Foto"]}),e.jsx(ie,{onRecordingComplete:$})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h5",{className:"font-semibold mb-2",children:"Historial de Comunicación"}),e.jsx("div",{className:"space-y-3 max-h-48 overflow-y-auto",children:s.comments.map(a=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"font-semibold",children:[a.userName," ",e.jsxs("span",{className:"text-xs text-gray-500",children:["(",new Date(a.date).toLocaleString(),")"]})]}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 whitespace-pre-wrap",children:a.text})]},a.id))}),R&&s.status!==i.Resolved&&e.jsxs("div",{className:"mt-4",children:[e.jsx("textarea",{value:u,onChange:M,rows:3,placeholder:"Añadir comentario o nota de seguimiento...",className:"w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"}),e.jsx("button",{onClick:B,className:"mt-2 bg-blue-600 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-blue-700",children:"Publicar"})]})]}),s.status===i.Resolved&&e.jsxs("div",{className:"pt-4 border-t bg-green-50 dark:bg-green-900/20 p-3 rounded-md",children:[e.jsxs("h5",{className:"font-semibold flex items-center text-green-800 dark:text-green-300",children:[e.jsx(ne,{className:"h-5 w-5 mr-2"}),"Caso Resuelto"]}),e.jsxs("p",{className:"text-sm mt-1",children:[e.jsx("strong",{className:"block",children:"Resuelto por:"})," ",H," el ",new Date(s.resolvedDate).toLocaleDateString()]}),e.jsxs("p",{className:"text-sm mt-2",children:[e.jsx("strong",{className:"block",children:"Notas de Resolución:"})," ",s.resolutionNotes]})]}),e.jsxs("div",{className:"pt-4 border-t flex justify-between items-start",children:[R&&s.status!==i.Resolved&&e.jsxs("div",{children:[!m&&e.jsx("button",{onClick:()=>x(!0),className:"bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-green-700",children:"Resolver Caso"}),m&&e.jsxs("div",{className:"animate-fade-in-down",children:[e.jsx("textarea",{value:h,onChange:a=>f(a.target.value),rows:3,placeholder:"Añadir notas finales de la resolución del caso...",className:"w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"}),e.jsxs("div",{className:"mt-2 space-x-2",children:[e.jsx("button",{onClick:O,className:"bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-green-700",children:"Confirmar Resolución"}),e.jsx("button",{onClick:()=>x(!1),className:"bg-gray-300 px-3 py-1 rounded text-sm",children:"Cancelar"})]})]})]}),e.jsxs("button",{onClick:U,className:"flex items-center text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded hover:bg-gray-300",children:[e.jsx(de,{className:"h-4 w-4 mr-1"}),"Imprimir"]})]}),e.jsx("div",{id:`printable-${s.id}`,className:"hidden",children:e.jsx(oe,{report:s,student:I,teacher:S})})]})]})};export{ue as R,he as f,xe as u};
