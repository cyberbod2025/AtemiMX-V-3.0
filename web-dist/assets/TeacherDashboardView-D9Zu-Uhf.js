import{d as D,g as U,a as w,s as X,M as Q,r as x,j as e,c as K,q as W,o as Y,w as Z,b as ee,e as ae,u as te,f as se,D as ne,C as re,h as ie,i as le}from"./index-D6sLf56H.js";import{R as oe}from"./ReportForm-Bxvlu24W.js";import{R as ce}from"./ReportCard-BhSixjG4.js";import{R as F,C as G,T as B}from"./CategoricalChart-IfPjQnPM.js";import{P as q,a as V}from"./PieChart-Z_O5KgID.js";import"./geminiService-fkZN5fdV.js";const $="gradebooks",de=async s=>{const n=D(w,$,s),t=await U(n);return t.exists()?t.data():null},ue=async(s,n)=>{const t=D(w,$,s);await X(t,n,{merge:!0})},M=[{min:0,max:5.9,bg:"#fee2e2",fg:"#991b1b"},{min:6,max:7.9,bg:"#fef9c3",fg:"#92400e"},{min:8,max:10,bg:"#dcfce7",fg:"#14532d"}],me=()=>{const s=Q.map(r=>({studentId:r.id,displayName:r.name})),n=[{id:"unidad1",label:"Unidad 1 · Diagnóstico",columns:[{id:"diag",label:"Diagnóstico (10)",type:"numeric",weight:.2,config:{min:0,max:10,colorRules:M}},{id:"participacion",label:"Participación",type:"icon",weight:.1,config:{icons:[{value:"⭐️",label:"Sobresaliente",points:10},{value:"✅",label:"Cumple",points:8},{value:"⚠️",label:"Atender",points:6}]}},{id:"producto1",label:"Producto integrador",type:"numeric",weight:.4,config:{min:0,max:100,colorRules:M}},{id:"resumen",label:"Resumen autoevaluación",type:"text"},{id:"promedio_u1",label:"Promedio U1",type:"formula",config:{formula:"average",fromColumns:["diag","producto1"]}}]},{id:"unidad2",label:"Unidad 2 · Proyecto",columns:[{id:"investigacion",label:"Investigación",type:"numeric",weight:.35,config:{min:0,max:10,colorRules:M}},{id:"rubrica",label:"Rúbrica Equipo",type:"numeric",weight:.35,config:{min:0,max:4,colorRules:[{min:0,max:1.9,bg:"#fee2e2",fg:"#991b1b"},{min:2,max:2.9,bg:"#fef9c3",fg:"#92400e"},{min:3,max:4,bg:"#dcfce7",fg:"#14532d"}]}},{id:"badgeMaker",label:"Insignias",type:"formula",config:{formula:"badgeMaker",fromColumns:["participacion"]}}]}],t=(r,c,h)=>({studentId:r,columnId:c,value:h}),i={};return s.forEach((r,c)=>{i[r.studentId]={},i[r.studentId].diag=t(r.studentId,"diag",6+c%5),i[r.studentId].participacion=t(r.studentId,"participacion",c%2===0?"⭐️":"✅"),i[r.studentId].producto1=t(r.studentId,"producto1",70+c*3),i[r.studentId].resumen=t(r.studentId,"resumen","Entrega puntual y participa."),i[r.studentId].investigacion=t(r.studentId,"investigacion",7+c%3),i[r.studentId].rubrica=t(r.studentId,"rubrica",2+c%3)}),{tabs:n,rows:s,cells:i}},pe=(s={})=>{var C;const{teacherId:n}=s,t=x.useMemo(()=>me(),[]),[i,r]=x.useState(t),[c,h]=x.useState(((C=i.tabs[0])==null?void 0:C.id)??"unidad1"),[N,y]=x.useState(!!n),[b,a]=x.useState(!1),[l,g]=x.useState(null),o=x.useRef(null),j=x.useRef(null);x.useEffect(()=>{if(!n){y(!1),r(t);return}y(!0),de(n).then(u=>{var f;u?(r(u),h(((f=u.tabs[0])==null?void 0:f.id)??"unidad1")):r(t),g(null)}).catch(u=>{console.error("[Gradebook] No se pudo cargar el cuaderno",u),g("No pudimos sincronizar el cuaderno. Mostramos una versión local."),r(t)}).finally(()=>y(!1))},[t,n]),x.useEffect(()=>()=>{o.current&&clearTimeout(o.current)},[]);const T=u=>{n&&(j.current=u,o.current&&clearTimeout(o.current),o.current=setTimeout(async()=>{if(j.current){a(!0);try{await ue(n,j.current),g(null)}catch(f){console.error("[Gradebook] No se pudo guardar el cuaderno",f),g("No pudimos guardar los cambios. Revisa tu conexión.")}finally{a(!1)}}},800))},d=(u,f,p)=>{r(v=>{const R=JSON.parse(JSON.stringify(v));return R.cells[u]||(R.cells[u]={}),R.cells[u][f]={studentId:u,columnId:f,value:p},T(R),R})},m=(u,f)=>{var p,v;return((v=(p=i.cells[u])==null?void 0:p[f])==null?void 0:v.value)??null},_=(u,f)=>{const p=m(u,f);return typeof p=="number"?p:typeof p=="string"&&p.trim().length>0&&!Number.isNaN(Number(p))?Number(p):null},k=(u,f=c)=>{const p=i.tabs.find(S=>S.id===f);if(!p)return 0;const v=p.columns.filter(S=>S.type!=="text"),R=v.reduce((S,I)=>{const A=_(u,I.id);if(A===null)return S;const J=I.weight??1;return S+A*J},0),H=v.reduce((S,I)=>S+(I.weight??1),0)||1;return Number((R/H).toFixed(2))},P=u=>{if(i.rows.length===0)return 0;const f=i.rows.reduce((p,v)=>p+k(v.studentId,u),0);return Number((f/i.rows.length).toFixed(2))};return{tabs:i.tabs,activeTabId:c,setActiveTabId:h,rows:i.rows,getValue:m,getNumericValue:_,updateCell:d,getAverageForStudent:k,getTabAverage:P,model:i,loading:N,saving:b,error:l}},he=(s,n)=>{var i;if(!((i=s.config)!=null&&i.colorRules)||n===null)return{};const t=s.config.colorRules.find(r=>n>=r.min&&n<=r.max);return t?{backgroundColor:t.bg,color:t.fg}:{}},ge=(s,n)=>{var t;return n==null||n===""?"—":s.type==="numeric"&&typeof n=="number"?n.toFixed((t=s.config)!=null&&t.max&&s.config.max<=5?1:0):n},xe=({teacherId:s})=>{const{tabs:n,activeTabId:t,setActiveTabId:i,rows:r,getValue:c,getNumericValue:h,updateCell:N,getAverageForStudent:y,loading:b,saving:a,error:l}=pe({teacherId:s}),g=n.find(d=>d.id===t)??n[0];if(!g)return null;const o=(d,m,_)=>{N(d,m,_.target.value)},j=(d,m)=>{var C,u,f;const _=c(d,m.id),k=h(d,m.id),P=m.type==="numeric"?he(m,k):void 0;if(m.type==="numeric")return e.jsx("input",{type:"number",className:"gradebook__cell-input",value:_??"",onChange:p=>o(d,m.id,p),min:((C=m.config)==null?void 0:C.min)??0,max:((u=m.config)==null?void 0:u.max)??100,style:P});if(m.type==="text")return e.jsx("textarea",{className:"gradebook__cell-text",value:_??"",onChange:p=>o(d,m.id,p)});if(m.type==="icon"){const p=((f=m.config)==null?void 0:f.icons)??[];return e.jsxs("select",{className:"gradebook__cell-select",value:_??"",onChange:v=>o(d,m.id,v),children:[e.jsx("option",{value:"",children:"Selecciona"}),p.map(v=>e.jsxs("option",{value:v.value,children:[v.value," ",v.label]},v.value))]})}return e.jsx("span",{children:ge(m,_)})},T=d=>e.jsx("button",{type:"button",className:`gradebook__tab ${d.id===t?"gradebook__tab--active":""}`,onClick:()=>i(d.id),children:d.label},d.id);return b?e.jsx("section",{className:"gradebook",children:"Sincronizando cuaderno..."}):e.jsxs("section",{className:"gradebook",children:[l?e.jsx("div",{className:"app-shell__notice",children:l}):null,e.jsxs("header",{className:"gradebook__header",children:[e.jsx("div",{className:"gradebook__tabs",children:n.map(T)}),e.jsxs("div",{className:"gradebook__metrics",children:[e.jsx("span",{className:"gradebook__metric-label",children:"Total alumnos"}),e.jsx("strong",{children:r.length})]}),a?e.jsx("span",{className:"gradebook__metric-hint",children:"Guardando cambios..."}):null]}),e.jsx("div",{className:"gradebook__table-wrapper",children:e.jsxs("table",{className:"gradebook__table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Alumno"}),g.columns.map(d=>e.jsx("th",{children:e.jsxs("div",{className:"gradebook__column-header",children:[e.jsx("span",{children:d.label}),d.weight?e.jsxs("small",{children:[Math.round(d.weight*100),"%"]}):null]})},d.id)),e.jsx("th",{children:"Promedio"})]})}),e.jsx("tbody",{children:r.map(d=>e.jsxs("tr",{children:[e.jsx("td",{className:"gradebook__student",children:d.displayName}),g.columns.map(m=>e.jsx("td",{children:j(d.studentId,m)},m.id)),e.jsx("td",{className:"gradebook__average",children:y(d.studentId)})]},d.studentId))})]})}),g.notes?e.jsx("p",{className:"gradebook__notes",children:g.notes}):null]})},O="plannerEntries",be=async s=>{const n=K(w,O),t=W(n,Z("teacherId","==",s),Y("dateISO","asc"));return(await ee(t)).docs.map(r=>r.data())},fe=async s=>{const n=K(w,O),t={...s,updatedAtISO:new Date().toISOString()},i=await se(n,t);return{...t,id:i.id}},je=async(s,n)=>{const t=D(w,O,s);await te(t,{...n,updatedAtISO:new Date().toISOString()})},ve=async s=>{const n=D(w,O,s);await ae(n)},ye=({teacherId:s})=>{const[n,t]=x.useState([]),[i,r]=x.useState(!!s),[c,h]=x.useState(null);return x.useEffect(()=>{if(!s){t([]),r(!1);return}r(!0),be(s).then(a=>{t(a),h(null)}).catch(a=>{console.error("[Planner] No se pudieron cargar las planeaciones",a),h("No pudimos sincronizar tu planner. Mostramos la vista local.")}).finally(()=>r(!1))},[s]),{entries:n,loading:i,error:c,addEntry:async a=>{if(!s)return;const l=await fe({...a,teacherId:s});t(g=>[...g,l].sort((o,j)=>o.dateISO.localeCompare(j.dateISO)))},updateEntry:async(a,l)=>{s&&(await je(a,l),t(g=>g.map(o=>o.id===a?{...o,...l,updatedAtISO:new Date().toISOString()}:o)))},removeEntry:async a=>{s&&(await ve(a),t(l=>l.filter(g=>g.id!==a)))}}},L=s=>{try{return new Intl.DateTimeFormat("es-MX",{dateStyle:"long"}).format(new Date(s))}catch{return s}},z={teacherId:"",dateISO:new Date().toISOString().split("T")[0],subject:"",field:"",objective:"",activities:"",resources:"",evaluationNotes:""},Ne=({teacher:s})=>{const{entries:n,loading:t,error:i,addEntry:r}=ye({teacherId:s.id}),[c,h]=x.useState({...z,teacherId:s.id}),[N,y]=x.useState(!1),b=async a=>{a.preventDefault(),y(!0);try{await r(c),h({...z,teacherId:s.id})}catch(l){console.error("[Planner] no se pudo guardar la planeación",l)}finally{y(!1)}};return e.jsxs("section",{className:"planner",children:[e.jsxs("header",{className:"planner__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"planner__eyebrow",children:"Planner Atemi"}),e.jsx("h3",{children:"Registro semanal"})]}),t?e.jsx("span",{className:"planner__status",children:"Sincronizando..."}):null,N?e.jsx("span",{className:"planner__status",children:"Guardando..."}):null]}),i?e.jsx("div",{className:"app-shell__notice",children:i}):null,e.jsxs("form",{className:"planner__form",onSubmit:b,children:[e.jsxs("div",{className:"planner__form-grid",children:[e.jsxs("label",{children:["Fecha",e.jsx("input",{type:"date",required:!0,value:c.dateISO,onChange:a=>h(l=>({...l,dateISO:a.target.value}))})]}),e.jsxs("label",{children:["Campo Formativo",e.jsx("input",{type:"text",required:!0,placeholder:"Ej. Saberes y Pensamiento Científico",value:c.field,onChange:a=>h(l=>({...l,field:a.target.value}))})]}),e.jsxs("label",{children:["Asignatura / Proyecto",e.jsx("input",{type:"text",required:!0,placeholder:"Matemáticas, Proyecto 2",value:c.subject,onChange:a=>h(l=>({...l,subject:a.target.value}))})]})]}),e.jsxs("label",{children:["Objetivo de la sesión",e.jsx("textarea",{required:!0,placeholder:"Describe el objetivo o propósito de aprendizaje...",value:c.objective,onChange:a=>h(l=>({...l,objective:a.target.value}))})]}),e.jsxs("label",{children:["Actividades clave",e.jsx("textarea",{required:!0,placeholder:"Secuencia de actividades, integración NEM, atención a la diversidad...",value:c.activities,onChange:a=>h(l=>({...l,activities:a.target.value}))})]}),e.jsxs("label",{children:["Recursos",e.jsx("textarea",{placeholder:"Materiales, tecnología, recursos Atemi...",value:c.resources,onChange:a=>h(l=>({...l,resources:a.target.value}))})]}),e.jsxs("label",{children:["Observaciones / Evaluación formativa",e.jsx("textarea",{placeholder:"Notas rápidas para reforzar la autoevaluación y coevaluación...",value:c.evaluationNotes,onChange:a=>h(l=>({...l,evaluationNotes:a.target.value}))})]}),e.jsx("button",{type:"submit",className:"planner__submit",disabled:N,children:N?"Guardando...":"Guardar planeación"})]}),e.jsxs("div",{className:"planner__list",children:[n.map(a=>e.jsxs("article",{className:"planner__card",children:[e.jsxs("header",{children:[e.jsx("span",{className:"planner__date",children:L(a.dateISO)}),e.jsx("h4",{children:a.subject}),e.jsx("p",{className:"planner__field",children:a.field})]}),e.jsxs("div",{className:"planner__body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Objetivo:"})," ",a.objective]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Actividades:"})," ",a.activities]}),a.resources?e.jsxs("p",{children:[e.jsx("strong",{children:"Recursos:"})," ",a.resources]}):null,a.evaluationNotes?e.jsxs("p",{children:[e.jsx("strong",{children:"Observaciones:"})," ",a.evaluationNotes]}):null]}),e.jsx("footer",{children:e.jsxs("small",{children:["Última actualización: ",L(a.updatedAtISO)]})})]},a.id)),n.length===0&&!t?e.jsx("p",{className:"planner__empty",children:"Aún no tienes planeaciones registradas."}):null]})]})},E=["#0088FE","#00C49F","#FFBB28","#FF8042"],Ie=({currentUser:s,viewStudentProfile:n})=>{const[t,i]=x.useState([]),[r,c]=x.useState(!1);x.useEffect(()=>{(async()=>{const a=await le(s.id);i(a.sort((l,g)=>new Date(g.date).getTime()-new Date(l.date).getTime()))})()},[s.id]);const h=b=>{i(a=>[b,...a]),c(!1)},N=b=>{i(a=>a.map(l=>l.id===b.id?b:l))},y=x.useMemo(()=>{const b=t.reduce((o,j)=>(o[j.type]=(o[j.type]||0)+1,o),{}),a=Object.entries(b).map(([o,j])=>({name:o,value:j})),l=t.reduce((o,j)=>(o[j.status]=(o[j.status]||0)+1,o),{}),g=Object.entries(l).map(([o,j])=>({name:o,value:j}));return{typeData:a,statusData:g}},[t]);return e.jsxs("div",{className:"space-y-8",children:[e.jsx(xe,{teacherId:s.id}),e.jsx(Ne,{teacher:s}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"Mi Panel"}),e.jsxs("button",{onClick:()=>c(!r),className:"flex items-center bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors",children:[e.jsx(ne,{className:"h-5 w-5 mr-2"}),r?"Cancelar Reporte":"Nuevo Reporte"]})]}),r&&e.jsx("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg animate-fade-in-down",children:e.jsx(oe,{currentUser:s,onReportSubmit:h})}),t.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-semibold flex items-center mb-4 text-gray-700 dark:text-gray-300",children:[e.jsx(re,{className:"h-6 w-6 mr-2"}),"Mis Estadísticas"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md h-64",children:[e.jsx("h4",{className:"font-semibold mb-2 text-center",children:"Mis Reportes por Tipo"}),e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(q,{children:[e.jsx(V,{data:y.typeData,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",innerRadius:40,outerRadius:60,fill:"#8884d8",paddingAngle:5,label:!0,children:y.typeData.map((b,a)=>e.jsx(G,{fill:E[a%E.length]},`cell-${a}`))}),e.jsx(B,{})]})})]}),e.jsxs("div",{className:"p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md h-64",children:[e.jsx("h4",{className:"font-semibold mb-2 text-center",children:"Mis Reportes por Estado"}),e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(q,{children:[e.jsx(V,{data:y.statusData,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",innerRadius:40,outerRadius:60,fill:"#82ca9d",paddingAngle:5,label:!0,children:y.statusData.map((b,a)=>e.jsx(G,{fill:E.slice(2)[a%E.length]},`cell-${a}`))}),e.jsx(B,{})]})})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-semibold flex items-center mb-4 text-gray-700 dark:text-gray-300",children:[e.jsx(ie,{className:"h-6 w-6 mr-2"}),"Historial de Reportes Enviados"]}),t.length>0?e.jsx("div",{className:"space-y-4",children:t.map(b=>e.jsx(ce,{report:b,viewStudentProfile:n,onReportUpdate:N,currentUser:s},b.id))}):e.jsx("div",{className:"text-center py-10 px-6 bg-white dark:bg-gray-800 rounded-lg shadow-md",children:e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No has enviado ningún reporte todavía."})})]})]})};export{Ie as default};
