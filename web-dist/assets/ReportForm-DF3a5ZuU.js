import{r as o,j as t,G as A,y as D,H as E,l as S,R as I,k as M,J as C,B as n,M as N}from"./index-B93U3tDT.js";import{b as P,t as F}from"./geminiService-fkZN5fdV.js";import{f as B,u as O}from"./ReportCard-C8iLMip1.js";const T=({onTranscription:e,disabled:a})=>{const[i,c]=o.useState(!1),[l,h]=o.useState(!1),s=o.useRef(null),p=o.useRef([]),m=o.useRef(null),f=()=>{s.current&&s.current.state==="recording"&&s.current.stop(),m.current&&(m.current.getTracks().forEach(d=>d.stop()),m.current=null),c(!1),h(!0)},x=async()=>{try{const d=await navigator.mediaDevices.getUserMedia({audio:!0});m.current=d;const g=new MediaRecorder(d);s.current=g,p.current=[],g.ondataavailable=b=>{p.current.push(b.data)},g.onstop=async()=>{var w;const b=((w=s.current)==null?void 0:w.mimeType)||"audio/webm",v=new Blob(p.current,{type:b});try{const j=await P(v),r=await F(j,b);e(r)}catch(j){console.error("Transcription failed:",j),alert("No se pudo transcribir el audio.")}finally{h(!1),p.current=[]}},g.start(),c(!0)}catch(d){console.error("Could not start recording:",d),alert("No se pudo acceder al micrófono. Por favor, verifica los permisos.")}},y=()=>{a||l||(i?f():x())},k=i?"text-red-500 animate-pulse":"text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400";return t.jsx("button",{type:"button",onClick:y,disabled:a||l,className:`p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors ${k}`,"aria-label":i?"Detener dictado":"Iniciar dictado",children:l?t.jsx(A,{className:"h-5 w-5 animate-spin"}):t.jsx(D,{className:"h-5 w-5"})})},$={disciplina:n.Disciplinary,disciplinario:n.Disciplinary,socioemocional:n.SocioEmotional,"socio-emocional":n.SocioEmotional,academico:n.Academic,académico:n.Academic,asistencia:n.Attendance},G=e=>{const a=e.trim().toLowerCase();return $[a]??n.Disciplinary},L=e=>({id:e.id,studentId:e.ownerEmail??e.ownerName??"sin-asignar",teacherId:e.uid,date:e.date.toDate().toISOString(),type:G(e.category),subject:e.title,description:e.description,status:I.InProgress,priority:S.Medium,actionsTaken:e.description,comments:[],evidence:[]}),H=async e=>{const a=new Date().toISOString(),c={id:(await C({title:e.subject||e.type,description:`${e.description}

Acciones inmediatas: ${e.actionsTaken}`,date:a,category:e.type,uid:e.teacher.id},{name:e.teacher.name,email:e.email??null,role:e.teacher.role})).id,studentId:e.studentId,teacherId:e.teacher.id,date:a,type:e.type,subject:e.subject,description:e.description,status:I.New,priority:S.Medium,actionsTaken:e.actionsTaken,comments:[],evidence:[]};return await O(c),c},z=async()=>{try{const[e,a]=await Promise.all([B(),E()]),i=new Map(e.map(s=>[s.id,s])),c=a.map(s=>i.get(s.id)??L(s)),l=new Set(a.map(s=>s.id));return[...e.filter(s=>!l.has(s.id)),...c]}catch(e){return console.error("[Dashboard] Falling back to mock reports set",e),await M()}},J=({currentUser:e,onCreated:a})=>{const[i,c]=o.useState(""),[l,h]=o.useState(""),[s,p]=o.useState(n.Disciplinary),[m,f]=o.useState(""),[x,y]=o.useState(""),[k,d]=o.useState(!1),[g,b]=o.useState(null),v=async r=>{if(r.preventDefault(),!i||!l||!m||!x){b("Por favor completa todos los campos.");return}const u=N.find(R=>R.id===i);d(!0),b(null);try{await H({teacher:e,studentId:i,studentName:(u==null?void 0:u.name)??"Alumno sin registro",subject:l,description:m,actionsTaken:x,type:s}),c(""),h(""),p(n.Disciplinary),f(""),y(""),a==null||a()}catch(R){console.error("[ReportForm] No se pudo registrar el reporte",R),b("No pudimos enviar el reporte. Intenta de nuevo.")}finally{d(!1)}},w=r=>{f(u=>(u?u+" ":"")+r)},j=r=>{y(u=>(u?u+" ":"")+r)};return t.jsxs("form",{onSubmit:v,className:"space-y-4",children:[t.jsx("h3",{className:"text-lg font-semibold border-b pb-2",children:"Registrar Nueva Incidencia"}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"student",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Alumno"}),t.jsxs("select",{id:"student",value:i,onChange:r=>c(r.target.value),className:"mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[t.jsx("option",{value:"",children:"Selecciona un alumno"}),N.map(r=>t.jsx("option",{value:r.id,children:r.name},r.id))]})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"reportType",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Tipo de Reporte"}),t.jsxs("select",{id:"reportType",value:s,onChange:r=>p(r.target.value),className:"mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[t.jsx("option",{value:n.Disciplinary,children:"Disciplinario"}),t.jsx("option",{value:n.SocioEmotional,children:"Socio-emocional"})]})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"subject",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Asignatura"}),t.jsx("input",{type:"text",id:"subject",value:l,onChange:r=>h(r.target.value),className:"mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"Ej. Matemáticas, Historia"})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Descripción de la Incidencia"}),t.jsxs("div",{className:"relative w-full",children:[t.jsx("textarea",{id:"description",rows:4,value:m,onChange:r=>f(r.target.value),className:"mt-1 block w-full p-2 pr-10 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"Describe detalladamente lo que sucedió o usa el micrófono para dictar..."}),t.jsx("div",{className:"absolute top-1 right-0 mt-1 mr-2",children:t.jsx(T,{onTranscription:w})})]})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"actionsTaken",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Acciones Tomadas Inmediatamente"}),t.jsxs("div",{className:"relative w-full",children:[t.jsx("textarea",{id:"actionsTaken",rows:2,value:x,onChange:r=>y(r.target.value),className:"mt-1 block w-full p-2 pr-10 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"¿Qué acciones se tomaron en el momento? Puedes dictar..."}),t.jsx("div",{className:"absolute top-1 right-0 mt-1 mr-2",children:t.jsx(T,{onTranscription:j})})]})]}),t.jsx("div",{className:"flex justify-end",children:t.jsx("button",{type:"submit",className:"bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors",disabled:k,children:k?"Enviando...":"Enviar Reporte"})}),g?t.jsx("p",{className:"text-red-400 text-sm",children:g}):null]})};export{J as R,z as g};
