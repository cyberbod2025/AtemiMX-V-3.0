rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{uid} {
      // ✅ Un usuario puede leer su propio documento,
      // o un admin/dirección puede leer cualquiera.
      allow read: if request.auth.uid == uid ||
                   request.auth.token.role in ['admin', 'direccion'];

      // ✅ Creación permitida solo a correos institucionales
      allow create: if request.auth != null &&
                    request.resource.data.email.matches('.*@institucion\\.mx$');

      // ✅ Actualización permitida solo a admin/dirección
      allow update: if request.auth.token.role in ['admin', 'direccion'];
    }

    match /docentes/{uid} {
      // ✅ El propio docente puede leer sus datos; admin/dirección supervisan
      allow read: if request.auth.uid == uid ||
                   request.auth.token.role in ['admin', 'direccion'];

      // ✅ El docente puede crear y actualizar su ficha
      allow create: if request.auth != null && request.auth.uid == uid;
      allow update: if request.auth != null && request.auth.uid == uid;
    }
  }
}
